!function(e){function s(n){if(E[n])return E[n].exports;var o=E[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,s),o.l=!0,o.exports}var E={};s.m=e,s.c=E,s.d=function(e,E,n){s.o(e,E)||Object.defineProperty(e,E,{configurable:!1,enumerable:!0,get:n})},s.n=function(e){var E=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(E,"a",E),E},s.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},s.p="",s(s.s=9)}([function(e,s){e.exports=require("express")},function(e,s,E){"use strict";E(8);e.exports={baseurl:"http://localhost",serverport:4e3,tokenexp:3600,secret:"avsnitin",database:"./db/fees.db",apppath:"E:/WebFees"}},function(e,s){e.exports=require("sqlite3")},function(e,s){e.exports=require("passport")},function(e,s){e.exports=require("passport-local")},function(e,s){e.exports=require("request")},function(e,s){e.exports=require("nodemailer")},function(e,s){e.exports=require("xoauth2")},function(e,s){e.exports=require("path")},function(e,s,E){e.exports=E(10)},function(e,s,E){"use strict";var n=E(0),o=E(8),t=E(11),a=E(12),A=E(13),C=E(14),r=E(15),D=E(16),T=E(17),O=E(3),R=(E(4).Strategy,E(1)),u=process.env.PORT||R.serverport,L=E(2).verbose(),i=new L.Database("./db/fees.db",L.OPEN_READWRITE,function(e){e&&console.error(e.message),console.log("Connected to the fees database."),i.close()}),_=E(18),l=E(19),S=E(20),c=E(23),I=E(24),d=E(25),N=E(26),f=E(27),g=E(28),B=E(29),M=E(36),b=E(37),m=E(38),P=E(39),p=E(40),U=E(41),y=E(42),H=o.join(R.apppath,"views"),v=o.join(R.apppath,"public"),Y=n();C.registerHelper("if_eq",function(e,s,E){return e==s?E.fn(this):E.inverse(this)}),Y.set("views",H),Y.engine("handlebars",A({defaultLayout:"layout"})),Y.set("view engine","handlebars"),Y.use(a.json()),Y.use(a.urlencoded({extended:!1})),Y.use(t()),Y.use(n.static(v)),Y.use(T({secret:"secret",saveUninitialized:!0,resave:!0})),Y.use(O.initialize()),Y.use(O.session()),Y.use(r({errorFormatter:function(e,s,E){for(var n=e.split("."),o=n.shift(),t=o;n.length;)t+="["+n.shift()+"]";return{param:t,msg:s,value:E}}})),Y.use(D()),Y.use(function(e,s,E){s.locals.success_msg=e.flash("success_msg"),s.locals.error_msg=e.flash("error_msg"),s.locals.error=e.flash("error"),s.locals.user=e.user||null,E()}),Y.use("/",_),Y.use("/menus",l),Y.use("/users",S),Y.use("/dbdata",c),Y.use("/company",I),Y.use("/groups",d),Y.use("/parties",N),Y.use("/trcds",f),Y.use("/trcdsubs",g),Y.use("/bills",B),Y.use("/receipts",M),Y.use("/outstandings",b),Y.use("/billreg",m),Y.use("/ledgers",P),Y.use("/rcptreg",p),Y.use("/tallyimport",U),Y.use("/tallyexport",y),Y.set("port",u),Y.listen(Y.get("port"),function(){console.log("Server started on port "+Y.get("port"))})},function(e,s){e.exports=require("cookie-parser")},function(e,s){e.exports=require("body-parser")},function(e,s){e.exports=require("express-handlebars")},function(e,s){e.exports=require("handlebars")},function(e,s){e.exports=require("express-validator")},function(e,s){e.exports=require("connect-flash")},function(e,s){e.exports=require("express-session")},function(e,s,E){"use strict";var n=E(0),o=n.Router();o.get("/",function(e,s){s.render("index")}),o.get("/about",function(e,s){s.render("about")}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router();o.get("/menuMasters",function(e,s){s.render("menuMasters")}),o.get("/GrpMast",function(e,s){s.render("../groups")}),o.get("/menuTrans",function(e,s){s.render("menuTrans")}),o.get("/menuIntegration",function(e,s){s.render("menuIntegration")}),o.get("/menuReports",function(e,s){s.render("menuReports")}),o.get("/menuSetting",function(e,s){s.render("menuSetting")}),o.get("/users/login",function(e,s){s.render("login")}),e.exports=o},function(e,s,E){"use strict";function n(e,s,E){if(e.isAuthenticated())return E();var n="Authetication Failed !";console.log(n),s.json({message:n})}var o=E(21),t=function(e){return e&&e.__esModule?e:{default:e}}(o),a=E(0),A=a.Router(),C=E(2).verbose(),r=(E(5),E(1)),D=E(3),T=E(4).Strategy,O=E(22),R=O.genSaltSync(10);A.get("/listall",n,function(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT USERID, USER_NAME, USER_EMAIL, ROLE FROM USERS",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),A.get("/details/:Id",function(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT * FROM USERS WHERE USERID = ?",[e.params.Id],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),A.get("/login",function(e,s,E){s.render("login")}),A.post("/login",D.authenticate("local",{successRedirect:"/",failureRedirect:"/",failureFlash:!0}),function(e,s){s.redirect("/dashboard")}),D.use(new T(function(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(o){o?res.json(o.message):n.get("SELECT USERID, SALT FROM USERS WHERE USERID = '"+e+"'",function(o,t){if(!t)return E(null,!1,{message:"Unknown User "+e});var a=O.hashSync(s,t.SALT);n.get("SELECT USERID, USER_NAME FROM USERS WHERE USERID = ? AND PASS = ?",e,a,function(e,s){return s?E(null,s):E(null,!1,{message:"Invalid password !!"})})})});n.close()})),D.serializeUser(function(e,s){s(null,e.USERID)}),D.deserializeUser(function(e,s){var E=new C.Database(r.database,C.OPEN_READWRITE,function(n){n?res.json(n.message):E.get("SELECT A.USERID, A.USER_NAME, A.ROLE, A.USER_EMAIL, A.DEFAULT_CO, B.COMPANY, A.DEFAULT_YEAR FROM users A LEFT JOIN COMPANY B ON A.DEFAULT_CO=B.CO_CODE WHERE userid = ?",e,function(e,E){return E?s(null,E):s(null,!1)})});E.close()}),A.get("/checkduplicateUser/:id",function(e,s){var E=new C.Database(r.database,C.OPEN_READWRITE,function(n){n?s.json(n.message):E.get("SELECT * FROM users WHERE userid = ?",+e.params.Id,function(e,E){return E?s.json({message:"Error"}):s.json({message:"OK"})})});E.close()}),A.get("/logout",function(e,s){e.logout(),e.flash("success_msg","You are logged out"),s.redirect("/users/login")}),A.get("/manageusers",function(e,s,E){s.render("manageusers")}),A.get("/register",function(e,s){s.render("register")}),A.post("/register",function(e,s){var E=e.body.userid,n=e.body.username,o=e.body.email,t=e.body.role,a=e.body.password,A=(e.body.password2,e.body.defaultCoID),D=e.body.defaultYear,T=new C.Database(r.database,C.OPEN_READWRITE,function(C){C?s.status(500).json({message:C.message,error:"Yes"}):T.get("SELECT * FROM users WHERE userid = ?",+e.params.Id,function(C,r){if(r)s.status(500).json({message:"Cannot add ! UserID :"+e.params.Id+" already exists!",error:"Yes"});else{var u=O.hashSync(a,R);T.run("INSERT INTO USERS (USERID, USER_NAME, PASS, SALT, USER_EMAIL, ROLE, DEFAULT_CO, DEFAULT_YEAR) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[E,n,u,R,o,t,A,D],function(e,E){e?s.status(500).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User Added successfully!",error:"Yes"}),s.end()})}})});T.close()}),A.get("/userprofile",function(e,s,E){s.render("userprofile")}),A.post("/updateUser",function(e,s){var E=e.body.USERID,n=e.body.USER_NAME,o=e.body.USER_EMAIL,t=e.body.ROLE,a=e.body.selectedCOName,A=e.body.DEFAULT_CO,D=e.body.DEFAULT_YEAR,T=new C.Database(r.database,C.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):(T.get("SELECT CO_CODE, COMPANY FROM COMPANY WHERE COMPANY = ? LIMIT 1",a,function(e,s){s&&(A=s.CO_CODE)}),T.get("SELECT * FROM users WHERE USERID = ?",E,function(e,a){if(a){T.run("UPDATE USERS SET USER_NAME = ?, USER_EMAIL = ?, ROLE = ?, DEFAULT_CO = ?, DEFAULT_YEAR = ? WHERE USERID = ?",[n,o,t,A,D,E],function(e,E){e?s.status(500).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User updated successfully!",error:"No"}),s.end()})}else s.status(500).json({message:"Cannot update! UserID : "+E+" does not exists!",error:"Yes"})}))});T.close()}),A.post("/forgot",function(e,s){if(console.log(e),e.isAuthenticated())return s.redirect("/");User.forgot(e,s,function(E){E?e.flash("error",E):e.flash("success","Please check your email for further instructions."),s.redirect("/")})}),A.post("/changepass",n,function(e,s){var n=e.body.USERID,o=e.body.cPwd1;e.body.cPwd2,E(5);e.checkBody("USERID","userid is required").notEmpty(),e.checkBody("cPwd1","Password is required").notEmpty(),e.checkBody("cPwd2","Passwords do not match").equals(e.body.cPwd1);var a=e.validationErrors();if(a){var A=a.map(function(e){return e.msg}),D=(0,t.default)(A);s.json({message:D,error:"Yes"})}else{var T=new C.Database(r.database,C.OPEN_READWRITE,function(e){if(e)s.status(500).json({message:e.message,error:"Yes"});else{var E=O.hashSync(o,R);T.run("UPDATE USERS SET PASS = ?, SALT = ? WHERE USERID = ?",[E,R,n],function(e,E){e?s.status(500).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Password changed successfully!",error:"No"}),s.end()})}});T.close()}}),A.post("/delete/:Id",function(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(E){E&&s.status(500).json({message:E.message,error:"Yes"});n.run("DELETE FROM USERS WHERE USERID = ?",[e.params.Id],function(E,n){E?s.status(500).json({message:E.message,error:"Yes"}):s.status(202).json({message:"user : '"+e.params.Id+"' deleted successfully !",error:"No"}),s.end()})});n.close()}),A.get("/changeCompany",function(e,s,E){s.render("changecompany")}),A.post("/updateCurrentCo",function(e,s){var E=e.user.USERID,n=(e.body[0].COMPANY,e.body[0].CO_CODE),o=new C.Database(r.database,C.OPEN_READWRITE,function(e){if(e)s.status(500).json({message:e.message,error:"Yes"});else{o.run("UPDATE USERS SET DEFAULT_CO = ? WHERE USERID = ?",[n,E],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User updated successfully!",error:"No"}),s.end(),o.close()})}})}),A.get("/changeYear",function(e,s,E){s.render("changeyear")}),A.post("/updateCurrentYr",function(e,s){var E=e.user.USERID,n=e.body[0],o=new C.Database(r.database,C.OPEN_READWRITE,function(e){if(e)s.status(202).json({message:e.message,error:"Yes"});else{o.run("UPDATE USERS SET DEFAULT_YEAR = ? WHERE USERID = ?",[n,E],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User updated successfully!",error:"No"}),s.end(),o.close()})}})}),e.exports=A},function(e,s){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,s){e.exports=require("bcryptjs")},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);E(3),E(4).Strategy;o.post("/EXEC",function(e,s,E){var n={p1:e.body.cmdType,p2:e.body.sqlStmt},o=new t.Database(a.database,t.OPEN_READWRITE,function(e){if(e&&s.json(e.message),"SELECT"===n.p1)var E=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),E.all(n.p2,[],function(e,E){e?s.json(e.message):s.json(E)})});else"UPDATE"===n.p1?o.run(n.p2,[],function(e,E){e?s.status(500).json(e.message):s.status(202).json({message:"updated"}),s.end()}):"DELETE"===n.p1?o.run(n.p2,[],function(e,E){e?s.status(500).json(e.message):s.status(202).json({message:"deleted"}),s.end()}):"INSERT"===n.p1?o.run(n.p2,[],function(e,E){e?s.status(500).json(e.message):s.status(202).json({message:"Inserted"}),s.end()}):s.status(202).json({message:"Invalid params"})});o.close()}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("company")}),o.get("/listall",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT CO_CODE, COMPANY, EMAIL, TEL1 FROM COMPANY",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),o.get("/details/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT * FROM COMPANY WHERE CO_CODE = ?",[e.params.Id],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),o.get("/yearslist",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT YEAR FROM YEARS",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),o.post("/register",function(e,s){var E=e.body.CO_CODE,n=e.body.COMPANY,o=void 0===e.body.ADD1?"":e.body.ADD1,A=void 0===e.body.ADD2?"":e.body.ADD2,C=void 0===e.body.ADD3?"":e.body.ADD3,r=void 0===e.body.STATE?"":e.body.STATE,D=void 0===e.body.CITY_DIST?"":e.body.CITY_DIST,T=void 0===e.body.PIN?"":e.body.PIN,O=void 0===e.body.EMAIL?"":e.body.EMAIL,R=void 0===e.body.TEL1?"":e.body.TEL1,u=void 0===e.body.TEL2?"":e.body.TEL2,L=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):L.get("SELECT * FROM COMPANY WHERE CO_CODE = ?",[E],function(e,t){if(t)s.status(202).json({message:"Cannot add ! CompanyID already exists!",error:"Yes"});else{L.run("INSERT INTO COMPANY (CO_CODE, COMPANY, ADD1, ADD2, ADD3, STATE, CITY_DIST, PIN, EMAIL, TEL1, TEL2) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )",[E,n,o,A,C,r,D,T,O,R,u],function(e,E){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Company Added successfully!",error:"Yes"}),s.end(),L.close()})}L.close()})})}),o.post("/update",function(e,s){var E=e.body.CO_CODE,n=e.body.COMPANY,o=void 0===e.body.ADD1?"":e.body.ADD1,A=void 0===e.body.ADD2?"":e.body.ADD2,C=void 0===e.body.ADD3?"":e.body.ADD3,r=void 0===e.body.STATE?"":e.body.STATE,D=void 0===e.body.CITY_DIST?"":e.body.CITY_DIST,T=void 0===e.body.PIN?"":e.body.PIN,O=void 0===e.body.EMAIL?"":e.body.EMAIL,R=void 0===e.body.TEL1?"":e.body.TEL1,u=void 0===e.body.TEL2?"":e.body.TEL2,L=void 0===e.body.BANK_NAME?"":e.body.BANK_NAME,i=void 0===e.body.AC_NUM?"":e.body.AC_NUM,_=void 0===e.body.AC_TYPE?"":e.body.AC_TYPE,l=void 0===e.body.IFSC_CODE?"":e.body.IFSC_CODE,S=void 0===e.body.MICR?"":e.body.MICR,c=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):c.get("SELECT * FROM COMPANY WHERE CO_CODE = ?",[E],function(e,t){if(t){var a="UPDATE COMPANY SET COMPANY = ?, ADD1 = ?, ADD2 = ? , ADD3 = ?, STATE = ?, CITY_DIST = ?, PIN = ?, EMAIL = ?, TEL1 = ?, TEL2 = ? ,";a+=" BANK_NAME = ? , AC_NUM = ? , AC_TYPE = ? , IFSC_CODE = ? , MICR = ? ",a+=" WHERE CO_CODE = ? ",c.run(a,[n,o,A,C,r,D,T,O,R,u,L,i,_,l,S,E],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Company updated successfully!",error:"No"}),s.end(),c.close()})}else s.status(202).json({message:"Cannot update ! Company ID"+E+"does not exists!",error:"Yes"})})})}),o.post("/delete/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.status(500).json({message:E.message,error:"Yes"});n.run("DELETE FROM COMPANY WHERE CO_CODE = ?",[e.params.Id],function(E,o){E?s.status(500).json({message:E.message,error:"Yes"}):s.status(202).json({message:"Company : '"+e.params.Id+"' deleted successfully !",error:"No"}),n.close(),s.end()})})}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("groupmast")}),o.get("/listall",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT CO_CODE, GRP_CODE, GRP_NAME FROM GROUP_MAST ",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),o.get("/details/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT * FROM GROUP_MAST WHERE GRP_CODE = ? ",[e.params.Id],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),o.post("/register",function(e,s){var E=e.body.GRP_CODE,n=e.body.GRP_NAME,o=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,A=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,C=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,r=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,D=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):D.get("SELECT * FROM GROUP_MAST WHERE GRP_CODE = ? ",[E],function(e,t){if(t)s.status(202).json({message:"Cannot add ! Group ID already exists!",error:"Yes"});else{D.run("INSERT INTO GROUP_MAST (CO_CODE, GRP_CODE, GRP_NAME, ADDRESS1, ADDRESS2, ADDRESS3, ADDRESS4) VALUES ( ?, ?, ?, ?, ?, ?, ?)",[0,E,n,o,A,C,r],function(e,E){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Group Added successfully!",error:"Yes"}),s.end()})}})});D.close()}),o.post("/update",function(e,s){var E=e.body.GRP_CODE,n=e.body.GRP_NAME,o=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,A=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,C=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,r=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,D=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):D.get("SELECT 1 FROM GROUP_MAST WHERE GRP_CODE = ?",[E],function(e,t){if(t){D.run("UPDATE GROUP_MAST SET GRP_NAME = ?, ADDRESS1 = ?, ADDRESS2 = ? , ADDRESS3 = ?, ADDRESS4 = ? WHERE GRP_CODE = ?",[n,o,A,C,r,E],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Group updated successfully!",error:"No"}),s.end(),D.close()})}else s.status(202).json({message:'Cannot update ! Group ID "'+E+'" does not exists!',error:"Yes"})})})}),o.post("/delete/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.status(202).json({message:E.message,error:"Yes"});n.get("SELECT 1 FROM ACC_MAST WHERE GRP_CODE = ?",[e.params.Id],function(E,o){if(o)n.close(),s.status(202).json({message:"Cannot delete group '"+e.params.Id+"' already in use !",error:"Yes"}),s.end();else{n.run("DELETE FROM GROUP_MAST WHERE GRP_CODE = ?",[e.params.Id],function(E,o){E?s.status(202).json({message:E.message,error:"Yes"}):s.status(202).json({message:"Group : '"+e.params.Id+"' deleted successfully !",error:"No"}),n.close(),s.end()})}})})}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("partymast")}),o.get("/listall",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT A.CO_CODE, A.GRP_CODE, B.GRP_NAME, A.AC_CODE, A.AC_NAME FROM ACC_MAST A, GROUP_MAST B WHERE A.GRP_CODE=B.GRP_CODE ",[],function(e,E){e?s.json(e.message):s.json(E)}),n.close()})}),o.get("/namelist",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT AC_NAME, AC_CODE FROM ACC_MAST ",[],function(e,E){e?s.json(e.message):s.json(E)}),n.close()})}),o.get("/grouplist",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT GRP_CODE, GRP_NAME FROM GROUP_MAST",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),o.get("/currentGroupID/:Nm",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT GRP_CODE FROM GROUP_MAST WHERE GRP_NAME = ?",[e.params.Nm],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({GRP_NAME:"Incorrect Group"})})});n.close()}),o.get("/currentGroupNm/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT GRP_NAME FROM GROUP_MAST WHERE GRP_CODE = ?",[e.params.Id],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({GRP_CODE:"Incorrect Group"})})});n.close()}),o.get("/details/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT A.*, B.GRP_NAME FROM ACC_MAST A, GROUP_MAST B WHERE A.AC_CODE = ? AND A.GRP_CODE=B.GRP_CODE ",[e.params.Id],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),o.get("/currentPartyID/:Nm",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT AC_CODE FROM ACC_MAST WHERE AC_NAME = ?",[e.params.Nm],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({AC_NAME:"Incorrect Party"})})});n.close()}),o.post("/register",function(e,s){var E=e.body.AC_CODE,n=e.body.GRP_CODE,o=e.body.AC_NAME,A=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,C=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,r=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,D=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,T=void 0===e.body.OFF_TEL1?"":e.body.OFF_TEL1,O=void 0===e.body.OFF_TEL2?"":e.body.OFF_TEL2,R=void 0===e.body.RES_TEL1?"":e.body.RES_TEL1,u=void 0===e.body.RES_TEL2?"":e.body.RES_TEL2,L=void 0===e.body.PAN1?"":e.body.PAN1,i=void 0===e.body.PAN2?"":e.body.PAN2,_=void 0===e.body.CLOSED?"":e.body.CLOSED,l=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(202).json({message:e.message,error:"Yes"}):l.get("SELECT * FROM ACC_MAST WHERE AC_CODE = ? ",[E],function(e,t){if(t)s.status(202).json({message:"Cannot add ! Party ID already exists!",error:"Yes"});else{var a="INSERT INTO ACC_MAST (CO_CODE, AC_CODE, GRP_CODE, AC_NAME, ADDRESS1, ADDRESS2, ADDRESS3, ADDRESS4, OFF_TEL1, OFF_TEL2, RES_TEL1, RES_TEL2, PAN1, PAN2, CLOSED) ";a+=" VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )",l.run(a,[0,E,n,o,A,C,r,D,T,O,R,u,L,i,_],function(e,E){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Party Added successfully!",error:"Yes"}),s.end()})}})});l.close()}),o.post("/update",function(e,s){var E=e.body.AC_CODE,n=e.body.GRP_CODE,o=e.body.AC_NAME,A=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,C=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,r=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,D=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,T=void 0===e.body.OFF_TEL1?"":e.body.OFF_TEL1,O=void 0===e.body.OFF_TEL2?"":e.body.OFF_TEL2,R=void 0===e.body.RES_TEL1?"":e.body.RES_TEL1,u=void 0===e.body.RES_TEL2?"":e.body.RES_TEL2,L=void 0===e.body.PAN1?"":e.body.PAN1,i=void 0===e.body.PAN2?"":e.body.PAN2,_=void 0===e.body.CLOSED?"":e.body.CLOSED,l=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):l.get("SELECT 1 FROM ACC_MAST WHERE AC_CODE = ?",[E],function(e,t){if(t){l.run("UPDATE ACC_MAST SET AC_NAME = ?, GRP_CODE = ?, ADDRESS1 = ?, ADDRESS2 = ? , ADDRESS3 = ?, ADDRESS4 = ?, OFF_TEL1=?, OFF_TEL2=?, RES_TEL1=?, RES_TEL2=? , PAN1= ?, PAN2=? , CLOSED= ? WHERE AC_CODE = ?",[o,n,A,C,r,D,T,O,R,u,L,i,_,E],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Party updated successfully!",error:"No"}),s.end()})}else s.status(202).json({message:'Cannot update ! Party ID "'+n+'" does not exists!',error:"Yes"})})});l.close()}),o.post("/delete/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.status(202).json({message:E.message,error:"Yes"});n.get("SELECT 1 FROM VOUCHERS WHERE AC_CODE = ?",[e.params.Id],function(E,o){if(o)s.status(202).json({message:'Cannot delete ! one or more bills exists for Party ID "'+e.params.Id+'" !',error:"Yes"});else{n.run("DELETE FROM ACC_MAST WHERE AC_CODE = ?",[e.params.Id],function(E,o){E?s.status(202).json({message:E.message,error:"Yes"}):s.status(202).json({message:"Party : '"+e.params.Id+"' deleted successfully !",error:"No"}),n.close(),s.end()})}})})}),o.get("/changeprtcode",function(e,s,E){s.render("changeprtcode")}),o.post("/changePartyCode",function(e,s){var E=e.body[0].AC_CODE,n=e.body[0].NEW_AC_CODE,o=new t.Database(a.database,t.OPEN_READWRITE,function(e){if(e)s.status(202).json({message:e.message,error:"Yes"});else{o.get("SELECT 1 FROM ACC_MAST WHERE AC_CODE = ?",[n],function(e,t){if(t)o.close(),s.status(202).json({message:"Cannot change! New Party code already exist !",error:"Yes"}),s.end();else{o.run("UPDATE ACC_MAST SET AC_CODE = ? WHERE AC_CODE = ?",[n,E],function(e,t){if(e)s.status(202).json({message:e.message,error:"Yes"});else{o.run("UPDATE VOUCHERS SET AC_CODE = ? WHERE AC_CODE = ?",[n,E],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):(s.status(202).json({message:"Party code updated successfully!",error:"No"}),o.close(),s.end())})}})}})}})}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("trcdmast")}),o.get("/listall",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT CO_CODE, TRCD, DESC FROM TRCD ",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),o.get("/details/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT * FROM TRCD WHERE TRCD = ? ",[e.params.Id],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),o.post("/register",function(e,s){var E=e.body.TRCD,n=e.body.DESC,o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):o.get("SELECT * FROM TRCD WHERE TRCD = ? ",[E],function(e,t){if(t)s.status(202).json({message:"Cannot add ! Transaction Code already exists!",error:"Yes"});else{o.run("INSERT INTO TRCD (CO_CODE, TRCD, DESC) VALUES ( ?, ?, ? )",[0,E,n],function(e,E){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Transaction Code Added successfully!",error:"Yes"}),s.end(),o.close()})}})})}),o.post("/update",function(e,s){var E=e.body.TRCD,n=e.body.DESC,o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):o.get("SELECT 1 FROM TRCD WHERE TRCD = ?",[E],function(e,t){if(t){o.run("UPDATE TRCD SET DESC = ?  WHERE TRCD = ?",[n,E],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Transaction Code updated successfully!",error:"No"}),o.close(),s.end()})}else s.status(202).json({message:'Cannot update ! Group ID "'+E+'" does not exists!',error:"Yes"})})})}),o.post("/delete/:Id",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.status(202).json({message:E.message,error:"Yes"});n.get("SELECT 1 FROM TRANSACT WHERE TRCD = ?",[e.params.Id],function(E,o){if(o)n.close(),s.status(202).json({message:"Cannot delete !! Transaction Code : '"+e.params.Id+"' already in use !",error:"Yes"});else{n.run("DELETE FROM TRCD WHERE TRCD = ?",[e.params.Id],function(E,o){E?s.status(202).json({message:E.message,error:"Yes"}):s.status(202).json({message:"Transaction Code : '"+e.params.Id+"' deleted successfully !",error:"No"}),n.close(),s.end()})}})})}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("trcdsubmast")}),o.get("/listall",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT A.*, B.DESC AS TRCDDESC FROM TRCDSUB A, TRCD B WHERE A.TRCD = B.TRCD ",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),o.get("/trcdlist",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT TRCD, DESC AS TRCDDESC FROM TRCD  ",[],function(e,E){e?s.json(e.message):s.json(E),n.close()})})}),o.get("/currentTrcdID/:Nm",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT TRCD FROM TRCD WHERE DESC = ?",[e.params.Nm],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({TRCD:"Incorrect Name"})})});n.close()}),o.get("/details/:Id",function(e,s,E){var n=e.params.Id,o=n.split("-"),A=o[0],C=o[1],r=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),r.all("SELECT A.*, B.DESC AS TRCDDESC FROM TRCDSUB A, TRCD B WHERE A.TRCD = B.TRCD AND A.TRCD = ? AND A.SUBCD = ? ",[A,C],function(e,E){e?s.json(e.message):s.json(E[0])})});r.close()}),o.post("/register",function(e,s){var E=e.body.TRCD,n=e.body.SUBCD,o=e.body.DESC,A=e.body.DEFAULT_AMT,C=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(202).json({message:e.message,error:"Yes"}):C.get("SELECT * FROM TRCDSUB WHERE TRCD = ? AND SUBCD = ? ",[E,n],function(e,t){if(t)s.status(202).json({message:'Cannot add ! Sub-transaction Code "'+E+"-"+n+'" already exists!',error:"Yes"});else{C.run("INSERT INTO TRCDSUB (CO_CODE, TRCD, SUBCD, DESC, DEFAULT_AMT) VALUES ( ?, ?, ?, ?, ?)",[0,E,n,o,A],function(e,E){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Sub-transaction Code Added successfully!",error:"Yes"}),C.close(),s.end()})}})})}),o.post("/update",function(e,s){var E=e.body.TRCD,n=e.body.SUBCD,o=e.body.DESC,A=e.body.DEFAULT_AMT,C=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(C.close(),s.status(500).json({message:e.message,error:"Yes"}),s.end()):C.get("SELECT 1 FROM TRCDSUB WHERE TRCD = ? AND SUBCD = ?",[E,n],function(e,t){if(t){C.run("UPDATE TRCDSUB SET DESC = ?, DEFAULT_AMT = ? WHERE TRCD = ? AND SUBCD = ?",[o,A,E,n],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Sub-Transaction updated successfully!",error:"No"}),C.close(),s.end()})}else s.status(202).json({message:'Cannot update ! Sub-transaction ID "'+E+"-"+n+'" does not exists!',error:"Yes"})})})}),o.post("/delete/:Id",function(e,s,E){var n=e.params.Id,o=n.split("-"),A=o[0],C=o[1],r=new t.Database(a.database,t.OPEN_READWRITE,function(E){E&&s.status(202).json({message:E.message,error:"Yes"});r.get("SELECT 1 FROM TRANSACT WHERE TRCD = ? AND SUBCD = ?",[A,C],function(E,n){if(n)r.close(),s.status(202).json({message:"Cannot delete !! Transaction Code : '"+e.params.Id+"' already in use !",error:"Yes"});else{r.run("DELETE FROM TRCDSUB WHERE TRCD = ? AND SUBCD = ?",[A,C],function(E,n){E?s.status(202).json({message:E.message,error:"Yes"}):s.status(202).json({message:"Sub-transaction Code : '"+e.params.Id+"' deleted successfully !",error:"No"}),r.close(),s.end()})}})})}),e.exports=o},function(e,s,E){"use strict";function n(e,s){for(var E=e+"";E.length<s;)E="0"+E;return E}function o(e){var s=e.getMonth(),E=e.getFullYear();if(s<=3)var n=E-1,o=E;else var n=E,o=E+1;return n.toString()+"-"+o.toString().substring(2)}function t(e){var s=e.getMonth(),E=e.getFullYear(),o=e.getDate();return E+"-"+n(s+1,2)+"-"+n(o,2)}function a(e,s){var E=new r.Database(D.database,r.OPEN_READWRITE,function(n){if(n)return s(null,!1);E.get("SELECT AC_CODE FROM ACC_MAST WHERE AC_CODE = ?",[e.AC_CODE],function(n,o){if(!o)return E.close(),s(null,!1);var t=!0;E.serialize(function(){for(var n=e.Transactions,o="SELECT COUNT(*) AS CNT FROM (",a=0;a<n.length;a++){var A=n[a].TRCD,C=n[a].SUBCD;o=0==a?o+" SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+A+"' AND SUBCD = '"+C+"' ":o+" UNION ALL SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+A+"' AND SUBCD = '"+C+"'"}o+=")",E.get(o,[],function(e,o){return t=!!o&&n.length==o.CNT,E.close(),s(null,t)})})})})}var A=E(0),C=A.Router(),r=E(2).verbose(),D=E(1),T=(E(30),E(31),E(32).EOL),O=E(6),R=E(7);E(33),E(34),E(35);C.get("/",function(e,s,E){s.render("makebills")}),C.get("/CurrentCoData",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT * FROM COMPANY WHERE CO_CODE = ?",[e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),C.get("/listall",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_STR, A.BILL_NO, A.BILL_DT, A.AC_CODE, B.AC_NAME, A.BILL_AMT, A.PREV_BAL, A.TOT_GST, A.TOT_AMT, A.CLIND  FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.YEAR= ? AND A.CO_CODE = ?  ORDER BY 3",[e.user.DEFAULT_YEAR,e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),C.get("/details/:Id",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT A.*, B.AC_NAME, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.ADDRESS4 FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),C.get("/PreviousBal/:PrtId",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E?(s.json({message:"No Data",error:"No"}),n.close()):n.all("SELECT COUNT(*) AS BILLCOUNT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[e.params.PrtId,e.user.DEFAULT_CO],function(E,o){E?(s.status(202).json({message:"No Data",error:"No"}),n.close()):o[0].BILLCOUNT>0?n.all("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT  FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[e.params.PrtId,e.user.DEFAULT_CO],function(e,E){e?s.json({message:"No Data",error:"No"}):s.json(E[0]),n.close()}):(s.status(202).json({message:"No Data",error:"No"}),n.close())})})}),C.get("/billtranctions/:Id",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E&&s.json(E.message);n.all("SELECT A.BILLID, A.CO_CODE, A.YEAR, A.BILL_NO, A.BILL_DT, A.TRCD, B.DESC AS TRCDDESC, A.SUBCD, C.DESC AS SUBDESC, A.REMARKS, A.BILL_AMT  FROM TRANSACT A, TRCD B, TRCDSUB C  WHERE A.TRCD=B.TRCD  AND A.TRCD=C.TRCD AND A.SUBCD=C.SUBCD  AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),C.get("/billfulldata/:Id",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){var o={};E&&s.json(E.message),n.all("SELECT A.*, B.AC_NAME, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.ADDRESS4 FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(E,t){if(E)s.json(E.message);else{o=t[0];n.all("SELECT A.BILLID, A.CO_CODE, A.YEAR, A.BILL_NO, A.BILL_DT, A.TRCD, B.DESC AS TRCDDESC, A.SUBCD, C.DESC AS SUBDESC, A.REMARKS, A.BILL_AMT  FROM TRANSACT A, TRCD B, TRCDSUB C  WHERE A.TRCD=B.TRCD  AND A.TRCD=C.TRCD AND A.SUBCD=C.SUBCD  AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):(o.transactions=E,s.json(o))})}})});n.close()}),C.post("/register",function(e,s){var E=e.user.DEFAULT_CO,n=0,a=t(new Date(e.body.selectedbillDt)),A=o(new Date(e.body.selectedbillDt)),C=e.body.AC_CODE,T=e.body.TOT_AMT,O=T,R=e.body.isClosed?"Y":"N",u=e.body.LASTBILLID,L=e.body.transactions,i=!1,_="",l=new r.Database(D.database,r.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):l.serialize(function(){l.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,o){n=o.NEWBILLID,l.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR =  ?",[E,A],function(e,o){var t=o&&o.NEWBILL_NO?o.NEWBILL_NO:1;l.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, CLIND, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )",[n,E,t,a,C,O,T,A,R,u],function(e,o){i=!!e,_=e?e.message:"",l.serialize(function(){for(var o=0;o<L.length;o++){var A=L[o].TRCD,C=L[o].SUBCD,r=L[o].REMARKS,D=L[o].BILL_AMT;l.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[n,E,t,a,A,C,r,D],function(e,s){i=!!e,_=e?e.message:""})}i?s.status(202).json({message:e.message,error:"Yes"}):(l.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[u],function(e,s){i=!!e,_=e?e.message:""}),s.status(202).json({message:"Bill Added successfully!",error:"No"})),l.close(),s.end()})})})})})})}),C.post("/update",function(e,s){var E=e.user.DEFAULT_CO,n=e.body.BILLID,o=e.body.BILL_NO,t=e.body.BILL_DT,a=e.body.AC_CODE,A=e.body.TOT_AMT,C=A,T=e.body.isClosed?"Y":"N",O=e.body.transactions,R=!1,u="",L=new r.Database(D.database,r.OPEN_READWRITE,function(e){e?(R=!0,u=e.message):L.get("SELECT 1 FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ?",[E,n],function(e,s){if(s){L.run("UPDATE VOUCHERS SET BILL_DT = ?, AC_CODE = ?, BILL_AMT = ? , TOT_AMT = ?, CLIND = ? WHERE CO_CODE = ? AND BILLID = ?",[t,a,C,A,T,E,n],function(e,s){if(e)R=!0,u=e.message;else{L.run("DELETE FROM TRANSACT  WHERE CO_CODE = ? AND BILLID = ?",[E,n],function(e,s){e?(R=!0,u=e.message):(L.serialize(function(){for(var e=0;e<O.length;e++){var s=O[e].TRCD,a=O[e].SUBCD,A=O[e].REMARKS,C=O[e].BILL_AMT;L.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[n,E,o,t,s,a,A,C],function(e,s){e?(R=!0,u=e.message):R=!1})}}),L.close())})}})}else R=!0,u=json({message:'Cannot update ! Bill "'+o+'" does not exists!',error:"Yes"})})});R?s.status(202).json({message:err.message,error:"Yes"}):s.status(202).json({message:"Bill update successfully!",error:"No"}),s.end()}),C.post("/delete/:Id",function(e,s,E){var n=e.params.Id,o=0,t="",a="",A=new r.Database(D.database,r.OPEN_READWRITE,function(e){if(e)s.status(202).json({message:e.message,error:"Yes"});else{var E="DELETE FROM VOUCHERS WHERE BILLID = ?",C="DELETE FROM TRANSACT WHERE BILLID = ?";A.get("SELECT CO_CODE, AC_CODE, LASTBILLID FROM VOUCHERS WHERE BILLID = ?",[n],function(e,r){o=r.CO_CODE,t=r.AC_CODE,a=r.LASTBILLID,console.log(r.LASTBILLID),0!=a?A.run("UPDATE VOUCHERS SET CLIND = 'N' WHERE CO_CODE= ? AND BILLID= ? AND CLIND = 'Y' ",[o,a],function(e,o){e||A.run(E,[n],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):A.run(C,[n],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Bill deleted successfully !",error:"No"}),A.close(),s.end()})})}):A.run(E,[n],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):A.run(C,[n],function(e,E){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Bill deleted successfully !",error:"No"}),A.close(),s.end()})})})}})}),C.get("/trcdlist",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(e){e&&(s.json(e.message),n.close()),n.all("SELECT DESC AS TRCDDESC FROM TRCD ",[],function(e,E){e?s.json(e.message):s.json(E),n.close()})})}),C.get("/currentTrcdID/:Nm",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT TRCD FROM TRCD WHERE DESC = ?",[e.params.Nm],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({TRCD:"Incorrect Name"})})});n.close()}),C.get("/trcdsublist",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT A.TRCD, A.DESC AS TRCDSUBDESC FROM TRCDSUB A ",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),C.post("/currentSUBCDIDp",function(e,s,E){var n=e.body.subcdnm,o=e.body.trcdid,t=new r.Database(D.database,r.OPEN_READWRITE,function(e){e&&s.json(e.message),t.all("SELECT SUBCD FROM TRCDSUB WHERE DESC = ? AND TRCD = ?",[n,o],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({SUBCD:"Incorrect Name"})})});t.close()}),C.get("/partylist",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT AC_NAME FROM ACC_MAST",[],function(e,E){e?s.json(e.message):s.json(E),n.close()})})}),C.get("/currentPartyID/:Nm",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT AC_CODE FROM ACC_MAST WHERE AC_NAME = ?",[e.params.Nm],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({AC_CODE:"Invalid Value"}),n.close()})})}),C.get("/currentPartyNm/:Id",function(e,s,E){var n=new r.Database(D.database,r.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT AC_NAME FROM ACC_MAST WHERE AC_CODE = ?",[e.params.Id],function(e,E){e?s.json(e.message):E?s.json(E[0]):s.json({AC_NAME:"Invalid Value"}),n.close()})})});var u=function(e,s,E,n){var o=new r.Database(D.database,r.OPEN_READWRITE,function(t){if(t)return n(null,0);o.get("SELECT BILLID FROM VOUCHERS WHERE CO_CODE = ? AND BILL_NO = ? AND BILL_DT = ?",[e,s,E],function(e,s){return s?n(null,s.BILLID):n(null,0)})})};C.post("/billimport",function(e,s,E){var n=e.body;"Add"==n.ACT?a(n,function(e,E){if(E)var t=new r.Database(D.database,r.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):t.serialize(function(){t.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,E){var a=E.NEWBILLID,A=o(new Date(n.BILL_DATE));t.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR = ?",[n.CO_CODE,A],function(e,E){for(var o=E&&E.NEWBILL_NO?E.NEWBILL_NO:1,C=n.Transactions,r=0,D=0;D<C.length;D++)r+=C[D].Amount;var T=r,O=0,R="";t.get("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[n.AC_CODE,n.CO_CODE],function(e,E){if(E){if(E.BAL_AMT>0){O=E.BAL_AMT,R=E.BILLID;var D={};D.TRCD="OST",D.SUBCD="",D.REMARKS="Bill No : "+E.BILL_NO+" dtd :  "+E.BILL_DT,D.Amount=E.BAL_AMT,C.splice(0,0,D),r+=O,T=r}}else O=0;t.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ? )",[a,n.CO_CODE,o,n.BILL_DATE,n.AC_CODE,T,r,A,R],function(e,E){t.serialize(function(){isError=!1;for(var E=0;E<C.length;E++){var A=C[E].TRCD,r=C[E].SUBCD,D=C[E].REMARKS,T=C[E].Amount;t.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[a,n.CO_CODE,o,n.BILL_DATE,A,r,D,T],function(e,s){isError=!!e})}isError?s.json({ResponseValue:e.message}):(t.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[R],function(e,s){isError=!!e,errMsg=e?e.message:""}),s.json({ResponseValue:"Bill Created!"}))})})})})})})});else s.json({ResponseValue:"Errors in Data!"})}):u(n.CO_CODE,n.BILL_NO,n.BILL_DATE,function(e,E){var o=E;o>0?"Delete"==n.ACT?s.json({ResponseValue:"Bill deleted!"}):a(n,function(e,E){if(E){console.log("updating the bill");var t=new r.Database(D.database,r.OPEN_READWRITE,function(e){t.get("SELECT 'X' FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ? AND CLIND = 'Y' ",[n.CO_CODE,o],function(e,E){if(E)s.json({ResponseValue:"Closed Bill cannot be updated!"});else{for(var a=0,A=n.Transactions,C=0;C<A.length;C++)a+=A[C].Amount;var r=a;t.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE = ? AND BILLID = ?",[r,a,n.CO_CODE,o],function(e,s){if(e)isError=!0,errMsg=e.message;else{t.run("DELETE FROM TRANSACT WHERE CO_CODE = ? AND BILLID = ? AND TRCD <> 'OST' ",[n.CO_CODE,o],function(e,s){e?(isError=!0,errMsg=e.message):t.serialize(function(){for(var e=0;e<A.length;e++){var s=A[e].TRCD,E=A[e].SUBCD,a=A[e].Amount;t.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ? )",[o,n.CO_CODE,n.BILL_NO,n.BILL_DATE,s,E,a],function(e,E){console.log(s),e?(isError=!0,errMsg=e.message,console.log(errMsg)):isError=!1})}t.get("SELECT SUM(BILL_AMT) AS TOTAL FROM TRANSACT WHERE CO_CODE= ? AND BILLID = ?",[n.CO_CODE,o],function(e,s){billtotAmt=s.TOTAL,billtotAmt1=s.TOTAL,t.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE= ? AND BILLID = ?",[billtotAmt,billtotAmt1,n.CO_CODE,o],function(e,s){isError=!!e,errMsg=e?e.message:"",console.log("database Closed"),t.close()})})})})}})}})});s.json({ResponseValue:"Bill updated!"})}else s.json({ResponseValue:"Errors in Data!"})}):s.json({ResponseValue:"Bill not found!"})})}),C.post("/billexport",function(e,s,E){var n=e.body.CO_CODE,o=e.body.YEAR,t=new r.Database(D.database,r.OPEN_READWRITE,function(e){s.statusCode=200,s.setHeader("Content-Type","text/csv");var E="CO_CODE|BILLID|BILL_NO|BILL_DT|AC_NAME|AC_CODE|TRCD_CODE|AMT"+T;t.all("SELECT A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_NO , A.BILL_DT, A.AC_CODE, B.AC_NAME , (C.TRCD || '_' || C.SUBCD) AS TRCD_CODE , C.BILL_AMT FROM VOUCHERS A, ACC_MAST B, TRANSACT C WHERE A.AC_CODE=B.AC_CODE AND C.CO_CODE=A.CO_CODE AND C.BILLID=A.BILLID AND A.CO_CODE= ? AND A.YEAR= ? ORDER BY 2,1",[n,o],function(e,n){if(e)t.close(),s.write("no data found"),s.end();else if(0==n.length)t.close(),s.write("no data found"),s.end();else{s.write(E);var o="";k=0,n.forEach(function(e){k++,o=e.CO_CODE+"|"+e.BILLID+"|"+e.BILL_NO+"|"+e.BILL_DT+"|"+e.AC_NAME+"|"+e.AC_CODE+"|"+e.TRCD_CODE+"|"+e.BILL_AMT+T,s.write(o),k==n.length&&s.end()})}})})}),C.post("/billsemail",function(e,s,E){console.log("sending emails");var n=O.createTransport({service:"gmail",auth:{xoauth2:R.creatXOAuth2Generator({user:"nitin.tandel16@gmail.com",clientId:"857597703416-5gs7tb40dduvr4pa8j97anmqqjml1p79.apps.googleusercontent.com",clientSecret:"xT-ed_l4-wX_6uiYJdNNpUcM",refreshToken:""})}}),o={from:"nitin.tandel16@gmail.com",to:"nitin_tandel16@yahoo.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"};n.sendMail(o,function(e,E){e?(console.log(e),s.json(e)):(console.log("Email sent: "+E.response),s.json({ResponseValue:"sent emails!"}))})}),e.exports=C},function(e,s,E){"use strict";e.exports={pageSize:"A4",pageMargins:[30,10,5,5],content:[{style:"tableExample",table:{widths:[540],body:[[{style:"dtable",table:{widths:[250,10,250],headerRows:1,body:[[{text:"<<CO_NAME>>",style:"tableHeader",colSpan:3,alignment:"center",border:[!1,!1,!1,!1]},{},{}],[{text:"<<CO_ADD>>",colSpan:3,alignment:"center",border:[!1,!1,!1,!1]},{},{}],[{text:"Tel : <<CO_TEL>>",border:[!1,!1,!1,!0]},{text:"",border:[!1,!1,!1,!0]},{text:"<<CO_EMAIL>>",alignment:"right",border:[!1,!1,!1,!0]}]]}}],[{style:"dtable",table:{widths:[250,10,250],headerRows:1,body:[["Bill No : <<BILL_NO>>","",{text:"Bill Date : <<BILL_DATE>>",alignment:"right"}]]},layout:"noBorders"}],[{style:"dtable",table:{widths:[250,10,250],headerRows:1,body:[[{text:"Client Name & Address :",style:"tableHeader",colSpan:3},{},{}],[{text:"<<PARTY_NM>>",colSpan:3},{},{}],[{text:"<<PARTY_ADD1>>",colSpan:3},{},{}],[{text:"<<PARTY_ADD2>>",colSpan:3},{},{}],[{text:"<<PARTY_ADD3>>",colSpan:3},{},{}]]},layout:"noBorders"}],[{style:"dtable",table:{widths:[20,410,80],headerRows:1,body:[[{text:"No",style:"tableHeader"},{text:"Particulars",style:"tableHeader"},{text:"Amount",style:"tableHeader",alignment:"right"}],[{text:"1",alignment:"right"},"<<BILL_TRAN>>",{text:"<<TRAN_AMT>>",alignment:"right"}],["",""," "],[{text:"Total :",style:"tableHeader",colSpan:2},{},{}]]}}],[{style:"dtable",table:{widths:[50,10,450],body:[[{text:"E.& O. E. Bank"},{},{text:"For <<CO_NAME>>,",style:"tableHeader",alignment:"right"}],[{text:"Bank   : "},{},{}],[{text:"A/c No : "},{},{}],[{text:"IFSC   : "},{},{}],[{},{},{text:"Prop.",style:"tableHeader",alignment:"right",border:[!1,!1,!1,!0]}]]},layout:"noBorders"}],[{style:"dtable",table:{widths:[520],body:[[{text:"Developed by A. V. Solutions",border:[!1,!0,!1,!1],pageBreak:"after"}]]}}]]},layout:"noBorders"}],styles:{header:{fontSize:18,bold:!0,margin:[0,0,0,10]},subheader:{fontSize:16,bold:!0,margin:[0,10,0,5]},tableExample:{margin:[0,5,0,15]},tableHeader:{bold:!0,fontSize:13,color:"black"}},defaultStyle:{}}},function(e,s){e.exports=require("async")},function(e,s){e.exports=require("os")},function(e,s){e.exports=require("fs")},function(e,s){e.exports=require("html-pdf")},function(e,s){e.exports=require("http")},function(e,s,E){"use strict";function n(e,s){for(var E=e+"";E.length<s;)E="0"+E;return E}function o(e){var s=e.getMonth(),E=e.getFullYear(),o=e.getDate();return console.log("formatdate"),E+"-"+n(s+1,2)+"-"+n(o,2)}var t=E(0),a=t.Router(),A=E(2).verbose(),C=E(1);a.get("/",function(e,s,E){s.render("enterreceipts")}),a.get("/listall",function(e,s,E){var n=new A.Database(C.database,A.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT A.BILLID, A.CO_CODE, A.BILL_NO, A.BILL_DT, A.AC_CODE, B.AC_NAME, B.GRP_CODE, A.TOT_AMT, A.RCPT_AMT, (A.TOT_AMT -  A.RCPT_AMT) AS BAL_AMT, A.CLIND \n            , SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_STR \n            FROM VOUCHERS A, ACC_MAST B  \n            WHERE A.AC_CODE=B.AC_CODE \n            AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n            AND A.CO_CODE = ? \n            ORDER BY B.GRP_CODE, A.AC_CODE ",[e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),a.get("/details/:Id",function(e,s,E){var n=new A.Database(C.database,A.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT A.*, B.AC_NAME, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.ADDRESS4, (A.TOT_AMT - A.RCPT_AMT) AS BAL_AMT FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E[0])})});n.close()}),a.post("/update",function(e,s){var E=(e.user.DEFAULT_CO,e.body.BILLID),n=e.body.isClosed?"Y":"N",t=e.body.RcptDt1?o(new Date(e.body.RcptDt1)):"",a=e.body.CASH1,r=e.body.CHEQUE1,D=e.body.RcptDt2?o(new Date(e.body.RcptDt2)):"",T=e.body.CASH2,O=e.body.CHEQUE2,R=e.body.CASH,u=e.body.CHEQUE,L=e.body.RCPT_AMT,i=!1,_="",l=new A.Database(C.database,A.OPEN_READWRITE,function(e){if(e)i=!0,_=e.message,s.end();else{l.run("UPDATE VOUCHERS SET RCPT_DATE = ?, CASH1 = ?, CHEQUE1 = ?, RCPT_DATE2 = ?, CASH2 = ?, CHEQUE2 = ?,  CASH = ? , CHEQUE = ? , RCPT_AMT = ?, CLIND = ? WHERE BILLID = ? ",[t,a,r,D,T,O,R,u,L,n,E],function(e,E){console.log(e),e?s.status(202).json({message:e.error,error:"Yes"}):s.status(202).json({message:"Receipts updated successfully!",error:"No"}),l.close(),s.end()})}})}),e.exports=a},function(e,s,E){"use strict";function n(e,s){var E=new C.Database(r.database,C.OPEN_READWRITE,function(n){if(n)return s(null,!1);E.get("SELECT AC_CODE FROM ACC_MAST WHERE AC_CODE = ?",[e.AC_CODE],function(n,o){if(!o)return E.close(),s(null,!1);var t=!0;E.serialize(function(){for(var n=e.Transactions,o="SELECT COUNT(*) AS CNT FROM (",a=0;a<n.length;a++){var A=n[a].TRCD,C=n[a].SUBCD;o=0==a?o+" SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+A+"' AND SUBCD = '"+C+"' ":o+" UNION ALL SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+A+"' AND SUBCD = '"+C+"'"}o+=")",E.get(o,[],function(e,o){return t=!!o&&n.length==o.CNT,E.close(),s(null,t)})})})})}function o(e,s){var E="CREATE TABLE \"COL_REG\" ( 'CO_CODE' INTEGER, 'BILLID' NUMERIC UNIQUE ",n=new C.Database(r.database,C.OPEN_READWRITE,function(e){n.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,o){var t=0;o.forEach(function(e){t++,E=E+", '"+e.COL_HEAD+"' NUMERIC ",t==o.length&&(E+=" , PRIMARY KEY('BILLID') )",n.run("DROP TABLE COL_REG",[],function(e,o){if(e)return n.close(),s(null,!1);n.run(E,[],function(e,E){return n.close(),e?s(null,!1):s(null,!0)})}))})})})}function t(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(o){n.run("INSERT INTO COL_REG (CO_CODE, BILLID) SELECT CO_CODE, BILLID FROM VOUCHERS WHERE CO_CODE=? AND YEAR = ?",[e,s],function(o,t){if(o)return E(null,!1);n.all("SELECT A.CO_CODE, A.BILLID, (A.TRCD || '_' || CASE WHEN A.SUBCD='' THEN 'XXX' ELSE A.SUBCD END) AS COL_HEAD, A.BILL_AMT FROM TRANSACT A, VOUCHERS B WHERE A.CO_CODE=B.CO_CODE AND A.BILLID = B.BILLID AND A.CO_CODE= ? AND B.YEAR = ?",[e,s],function(s,o){n.serialize(function(){var s=0;o.forEach(function(t){var a=t.BILLID,A=t.COL_HEAD,C="UPDATE COL_REG SET "+A+" = "+t.BILL_AMT+" WHERE CO_CODE = ? AND BILLID = ?";n.run(C,[e,a],function(e,t){return e?(n.close(),E(null,!1)):++s==o.length?(n.close(),E(null,!0)):void 0})})})})})})}var a=E(0),A=a.Router(),C=E(2).verbose(),r=E(1),D=E(6),T=E(7);A.get("/",function(e,s,E){s.render("outstandings")}),A.get("/listall",function(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT C.GRP_CODE, A.AC_CODE, C.AC_NAME, B.COMPANY, A.BILL_NO, A.BILL_DT, A.TOT_AMT\n              , (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END) AS RCPT_AMT \n              , (A.TOT_AMT- (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END)) AS BAL_AMT \n              FROM VOUCHERS A, COMPANY B, ACC_MAST C\n              WHERE A.CO_CODE = B.CO_CODE\n              AND A.AC_CODE=C.AC_CODE\n              AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n              AND B.CO_CODE = ?\n              ORDER BY 1, 2",[e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),A.post("/allOS",function(e,s,E){var n=e.body.grouplist,o="SELECT C.GRP_CODE, A.AC_CODE, C.AC_NAME, B.COMPANY, A.BILL_NO, A.BILL_DT, A.TOT_AMT\n              , (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END) AS RCPT_AMT \n              , (A.TOT_AMT- (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END)) AS BAL_AMT \n              FROM VOUCHERS A, COMPANY B, ACC_MAST C\n              WHERE A.CO_CODE = B.CO_CODE\n              AND A.AC_CODE=C.AC_CODE\n              AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n              <<SPECIFICGROUPOPTION>>\n              ORDER BY 1, 2";o=2==e.body.datascope?o.replace("<<SPECIFICGROUPOPTION>>","AND GRP_CODE IN "+n):o.replace("<<SPECIFICGROUPOPTION>>"," ");var t=new C.Database(r.database,C.OPEN_READWRITE,function(e){e&&s.json(e.message),t.all(o,[],function(e,E){e?s.json(e.message):s.json(E)})});t.close()});var O=function(e,s,E,n){var o=new C.Database(r.database,C.OPEN_READWRITE,function(t){if(t)return n(null,0);o.get("SELECT BILLID FROM VOUCHERS WHERE CO_CODE = ? AND BILL_NO = ? AND BILL_DT = ?",[e,s,E],function(e,s){return s?n(null,s.BILLID):n(null,0)})})};A.post("/billimport",function(e,s,E){var o=e.body;"Add"==o.ACT?n(o,function(e,E){if(E)var n=new C.Database(r.database,C.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):n.serialize(function(){n.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,E){var t=E.NEWBILLID,a=getFinYear(new Date(o.BILL_DATE));n.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR = ?",[o.CO_CODE,a],function(e,E){for(var A=E&&E.NEWBILL_NO?E.NEWBILL_NO:1,C=o.Transactions,r=0,D=0;D<C.length;D++)r+=C[D].Amount;var T=r,O=0,R="";n.get("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[o.AC_CODE,o.CO_CODE],function(e,E){if(E){if(E.BAL_AMT>0){O=E.BAL_AMT,R=E.BILLID;var D={};D.TRCD="OST",D.SUBCD="",D.REMARKS="Bill No : "+E.BILL_NO+" dtd :  "+E.BILL_DT,D.Amount=E.BAL_AMT,C.splice(0,0,D),r+=O,T=r}}else O=0;n.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ? )",[t,o.CO_CODE,A,o.BILL_DATE,o.AC_CODE,T,r,a,R],function(e,E){n.serialize(function(){isError=!1;for(var E=0;E<C.length;E++){var a=C[E].TRCD,r=C[E].SUBCD,D=C[E].REMARKS,T=C[E].Amount;n.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[t,o.CO_CODE,A,o.BILL_DATE,a,r,D,T],function(e,s){isError=!!e})}isError?s.json({ResponseValue:e.message}):(n.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[R],function(e,s){isError=!!e,errMsg=e?e.message:""}),s.json({ResponseValue:"Bill Created!"}))})})})})})})});else s.json({ResponseValue:"Errors in Data!"})}):O(o.CO_CODE,o.BILL_NO,o.BILL_DATE,function(e,E){var t=E;t>0?"Delete"==o.ACT?s.json({ResponseValue:"Bill deleted!"}):n(o,function(e,E){if(E){console.log("updating the bill");var n=new C.Database(r.database,C.OPEN_READWRITE,function(e){n.get("SELECT 'X' FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ? AND CLIND = 'Y' ",[o.CO_CODE,t],function(e,E){if(E)s.json({ResponseValue:"Closed Bill cannot be updated!"});else{for(var a=0,A=o.Transactions,C=0;C<A.length;C++)a+=A[C].Amount;var r=a;n.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE = ? AND BILLID = ?",[r,a,o.CO_CODE,t],function(e,s){if(e)isError=!0,errMsg=e.message;else{n.run("DELETE FROM TRANSACT WHERE CO_CODE = ? AND BILLID = ? AND TRCD <> 'OST' ",[o.CO_CODE,t],function(e,s){e?(isError=!0,errMsg=e.message):n.serialize(function(){for(var e=0;e<A.length;e++){var s=A[e].TRCD,E=A[e].SUBCD,a=A[e].Amount;n.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ? )",[t,o.CO_CODE,o.BILL_NO,o.BILL_DATE,s,E,a],function(e,E){console.log(s),e?(isError=!0,errMsg=e.message,console.log(errMsg)):isError=!1})}n.get("SELECT SUM(BILL_AMT) AS TOTAL FROM TRANSACT WHERE CO_CODE= ? AND BILLID = ?",[o.CO_CODE,t],function(e,s){billtotAmt=s.TOTAL,billtotAmt1=s.TOTAL,n.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE= ? AND BILLID = ?",[billtotAmt,billtotAmt1,o.CO_CODE,t],function(e,s){isError=!!e,errMsg=e?e.message:"",console.log("database Closed"),n.close()})})})})}})}})});s.json({ResponseValue:"Bill updated!"})}else s.json({ResponseValue:"Errors in Data!"})}):s.json({ResponseValue:"Bill not found!"})})}),A.post("/billexport",function(e,s,E){var n=e.body.CO_CODE,a=e.body.YEAR;o(e.body,function(e,E){E?t(n,a,function(e,E){if(E)var n=new C.Database(r.database,C.OPEN_READWRITE,function(e){s.statusCode=200,s.setHeader("Content-Type","text/csv");var E="CO_CODE, BILL_NO, BILL_DT, AC_NAME, AC_CODE ";n.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,o){k=0,o.forEach(function(e){E=E+","+e.COL_HEAD,++k==o.length&&(E+=endOfLine)}),n.all("SELECT A.CO_CODE AS CCODE, B.BILL_NO, B.BILL_DT, C.AC_NAME, B.AC_CODE, A.* FROM COL_REG A, VOUCHERS B, ACC_MAST C WHERE A.CO_CODE=B.CO_CODE AND A.BILLID=B.BILLID AND B.AC_CODE = C.AC_CODE",[],function(e,o){e?(n.close(),s.write("no data found"),s.end()):(s.write(E),i=0,o.forEach(function(e){var E="";for(var t in e)if("CO_CODE"!=t&&"BILLID"!=t){var a=null==e[t]?"0":e[t];E=E+a+","}E+=endOfLine,s.write(E),++i==o.length&&(n.close(),s.end())}))})})});else s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end()}):(s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end())})}),A.post("/osemail",function(e,s,E){console.log("sending emails for outstanding");var n=D.createTransport({service:"gmail",auth:{xoauth2:T.creatXOAuth2Generator({user:"nitin.tandel16@gmail.com",clientId:"857597703416-5gs7tb40dduvr4pa8j97anmqqjml1p79.apps.googleusercontent.com",clientSecret:"xT-ed_l4-wX_6uiYJdNNpUcM",refreshToken:""})}}),o={from:"nitin.tandel16@gmail.com",to:"nitin_tandel16@yahoo.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"};n.sendMail(o,function(e,E){e?(console.log(e),s.json(e)):(console.log("Email sent: "+E.response),s.json({ResponseValue:"sent emails!"}))})}),e.exports=A},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("billreg")}),o.post("/billsdata",function(e,s,E){var n=e.body.CO_CODE,o=e.body.YEAR,A=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),A.all("SELECT A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_NO , A.BILL_DT\n             , B.GRP_CODE , A.AC_CODE, B.AC_NAME , C.TRCD  , SUM(C.BILL_AMT) AS BILLAMT, A.RCPT_AMT, RCPT_DATE \n             , GROUP_CONCAT(C.TRCD || C.SUBCD) AS TRANLIST  \n             FROM VOUCHERS A, ACC_MAST B, TRANSACT C \n             WHERE A.AC_CODE=B.AC_CODE AND C.CO_CODE=A.CO_CODE AND C.BILLID=A.BILLID \n             AND A.CO_CODE= ? AND A.YEAR= ?\n             GROUP BY A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4), A.BILL_DT, A.AC_CODE, B.AC_NAME , C.TRCD , A.RCPT_AMT, RCPT_DATE\n             ORDER BY 2,1",[n,o],function(e,E){e?s.json(e.message):s.json(E)})});A.close()}),o.post("/headernames",function(e,s,E){var n=e.body.CO_CODE,o=e.body.YEAR,A=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),A.all("SELECT DISTINCT C.TRCD, C.DESC \n             FROM VOUCHERS A,  TRANSACT B , TRCD C\n             WHERE A.CO_CODE=A.CO_CODE AND A.BILLID=B.BILLID AND B.TRCD = C.TRCD\n             AND B.TRCD<>'OST'\n             AND A.CO_CODE= ? AND A.YEAR= ?",[n,o],function(e,E){e?s.json(e.message):s.json(E)})});A.close()}),o.get("/CurrentYearData",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E?s.json(E.message):n.get("SELECT USERID, YEAR, FROM_DT, TO_DT FROM USERS A, YEARS B WHERE A.DEFAULT_YEAR  = B.YEAR AND B.YEAR = ? ",[e.user.DEFAULT_YEAR],function(e,E){E?s.json(E):s.json(e.message)}),n.close()})}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("ledgers")}),o.post("/ledgerdata",function(e,s,E){var n=e.body.CO_CODE,o=(e.body.YEAR,e.body.FROM_DT),A=e.body.TO_DT,C=e.body.datascope,r=e.body.partylist,D=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message);var E="SELECT A.AC_CODE, B.AC_NAME, '<<FROM_DT>>' AS TRAN_DT, 'Opening Balance ... ' AS TRAN, 0 AS BILL_AMOUNT, 0 AS RCPT_AMOUNT,  CASE WHEN  A.CLIND ='Y' THEN 0 ELSE  SUM( TOT_AMT - RCPT_AMT ) END AS BAL_AMT , 'N' AS CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.BILL_DT < '<<FROM_DT>>'\n              AND A.RCPT_DATE < '<<FROM_DT>>'\n              AND A.RCPT_DATE2 < '<<FROM_DT>>'\n              AND A.CO_CODE = <<CO_CODE>>\n              <<SELECTED_PARTIES>>\n              GROUP BY A.AC_CODE, 'Opening Balance ... '\n              UNION \n              SELECT A.AC_CODE, B.AC_NAME, A.BILL_DT AS TRAN_DT, 'Bill No : ' || A.BILL_NO AS TRAN, A.TOT_AMT AS BILL_AMOUNT, 0 AS RCPT_AMOUNT , 0 AS BAL_AMT, A.CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.CO_CODE = <<CO_CODE>>\n              AND A.BILL_DT BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n              <<SELECTED_PARTIES>>\n              UNION\n              SELECT A.AC_CODE, B.AC_NAME, A.RCPT_DATE  AS TRAN_DT, 'Receipt'  AS TRAN, 0 AS BILL_AMOUNT, A.CASH1 + A.CHEQUE1 AS  RCPT_AMOUNT , 0 AS BAL_AMT, A.CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.CO_CODE = <<CO_CODE>>\n              AND A.CASH1 + A.CHEQUE1 > 0\n              AND A.RCPT_DATE BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n              <<SELECTED_PARTIES>>\n              UNION\n              SELECT A.AC_CODE, B.AC_NAME,  A.RCPT_DATE2  AS TRAN_DT, 'Receipt'  AS TRAN, 0 AS BILL_AMOUNT, A.CASH2 + A.CHEQUE2 AS  RCPT_AMOUNT , 0 AS BAL_AMT , A.CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.CO_CODE = <<CO_CODE>>\n              AND A.CASH2 + A.CHEQUE2 > 0\n              AND A.RCPT_DATE2 BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n              <<SELECTED_PARTIES>>\n              ORDER BY 1, 3";E=E.replace(/<<FROM_DT>>/g,o),E=E.replace(/<<TO_DT>>/g,A),E=E.replace(/<<CO_CODE>>/g,n),E=2==C?E.replace(/<<SELECTED_PARTIES>>/g,"AND A.AC_CODE IN "+r):E.replace(/<<SELECTED_PARTIES>>/g,""),console.log(E),D.all(E,[],function(e,E){e?(console.log(e),s.json(e.message)):s.json(E)})});D.close()}),o.post("/headernames",function(e,s,E){var n=e.body.CO_CODE,o=e.body.YEAR,A=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),A.all("SELECT DISTINCT C.TRCD, C.DESC \n             FROM VOUCHERS A,  TRANSACT B , TRCD C\n             WHERE A.CO_CODE=A.CO_CODE AND A.BILLID=B.BILLID AND B.TRCD = C.TRCD\n             AND B.TRCD<>'OST'\n             AND A.CO_CODE= ? AND A.YEAR= ?",[n,o],function(e,E){e?s.json(e.message):s.json(E)})});A.close()}),o.get("/CurrentYearData",function(e,s,E){var n=new t.Database(a.database,t.OPEN_READWRITE,function(E){E?s.json(E.message):n.get("SELECT USERID, YEAR, FROM_DT, TO_DT FROM USERS A, YEARS B WHERE A.DEFAULT_YEAR  = B.YEAR AND B.YEAR = ? ",[e.user.DEFAULT_YEAR],function(e,E){E?s.json(E):s.json(e.message)}),n.close()})}),e.exports=o},function(e,s,E){"use strict";var n=E(0),o=n.Router(),t=E(2).verbose(),a=E(1);o.get("/",function(e,s,E){s.render("rcptreg")}),o.post("/rcptregdata",function(e,s,E){var n=e.body.CO_CODE,o=e.body.FROM_DT,A=e.body.TO_DT,C=(e.body.datascope,e.body.partylist,e.body.grouplist),r=e.body.RcptOption,D="SELECT A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME, A.BILL_NO, A.TOT_AMT, A.RCPT_DATE, CASH1, CHEQUE1 , (CASH1 + CHEQUE1 ) AS RCPT_AMOUNT\n                  FROM VOUCHERS A, ACC_MAST B\n                  WHERE A.AC_CODE= B.AC_CODE AND A.RCPT_DATE BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n                  AND A.CO_CODE = <<CO_CODE>>\n                  AND CASH1 + CHEQUE1 > 0\n                  <<SPECIFICRCPTTYPE1>>\n                  <<SPECIFICGROUPOPTION>>\n                  <<SPECIFIC_PARTYOPTION>>\n                  UNION \n                  SELECT A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME,  A.BILL_NO, A.TOT_AMT, A.RCPT_DATE2, CASH2, CHEQUE2 , (CASH2 + CHEQUE2 ) AS RCPT_AMOUNT\n                  FROM VOUCHERS A, ACC_MAST B\n                  WHERE A.AC_CODE = B.AC_CODE AND A.RCPT_DATE2 BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n                  AND CASH2 + CHEQUE2 > 0\n                  AND A.CO_CODE = <<CO_CODE>>\n                  <<SPECIFICRCPTTYPE2>>\n                  <<SPECIFICGROUPOPTION>>\n                  <<SPECIFIC_PARTYOPTION>>\n                  ORDER BY 1, 7";D=D.replace(/<<FROM_DT>>/g,o),D=D.replace(/<<TO_DT>>/g,A),D=D.replace(/<<CO_CODE>>/g,n),1==r&&(D=D.replace(/<<SPECIFICRCPTTYPE1>>/g," AND CASH1 > 0 "),D=D.replace(/<<SPECIFICRCPTTYPE2>>/g," AND CASH2 > 0 ")),2==r&&(D=D.replace(/<<SPECIFICRCPTTYPE1>>/g," AND CHEQUE1 > 0 "),D=D.replace(/<<SPECIFICRCPTTYPE2>>/g," AND CHEQUE2 > 0 ")),3==r&&(D=D.replace(/<<SPECIFICRCPTTYPE1>>/g," "),D=D.replace(/<<SPECIFICRCPTTYPE2>>/g," ")),D=D.replace(/<<SPECIFIC_PARTYOPTION>>/g,""),D=2==e.body.datascope?D.replace(/<<SPECIFICGROUPOPTION>>/g,"AND B.GRP_CODE IN "+C):D.replace(/<<SPECIFICGROUPOPTION>>/g,"");var T=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),T.all(D,[],function(e,E){e?s.json(e.message):s.json(E)})});T.close()}),e.exports=o},function(e,s,E){"use strict";function n(e,s){var E=new C.Database(r.database,C.OPEN_READWRITE,function(n){if(n)return s(null,!1);E.get("SELECT AC_CODE FROM ACC_MAST WHERE AC_CODE = ?",[e.AC_CODE],function(n,o){if(!o)return E.close(),s(null,!1);var t=!0;E.serialize(function(){for(var n=e.Transactions,o="SELECT COUNT(*) AS CNT FROM (",a=0;a<n.length;a++){var A=n[a].TRCD,C=n[a].SUBCD;o=0==a?o+" SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+A+"' AND SUBCD = '"+C+"' ":o+" UNION ALL SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+A+"' AND SUBCD = '"+C+"'"}o+=")",E.get(o,[],function(e,o){return t=!!o&&n.length==o.CNT,E.close(),s(null,t)})})})})}function o(e,s){var E="CREATE TABLE \"COL_REG\" ( 'CO_CODE' INTEGER, 'BILLID' NUMERIC UNIQUE ",n=new C.Database(r.database,C.OPEN_READWRITE,function(e){n.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,o){var t=0;o.forEach(function(e){t++,E=E+", '"+e.COL_HEAD+"' NUMERIC ",t==o.length&&(E+=" , PRIMARY KEY('BILLID') )",n.run("DROP TABLE COL_REG",[],function(e,o){if(e)return n.close(),s(null,!1);n.run(E,[],function(e,E){return n.close(),e?s(null,!1):s(null,!0)})}))})})})}function t(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(o){n.run("INSERT INTO COL_REG (CO_CODE, BILLID) SELECT CO_CODE, BILLID FROM VOUCHERS WHERE CO_CODE=? AND YEAR = ?",[e,s],function(o,t){if(o)return E(null,!1);n.all("SELECT A.CO_CODE, A.BILLID, (A.TRCD || '_' || CASE WHEN A.SUBCD='' THEN 'XXX' ELSE A.SUBCD END) AS COL_HEAD, A.BILL_AMT FROM TRANSACT A, VOUCHERS B WHERE A.CO_CODE=B.CO_CODE AND A.BILLID = B.BILLID AND A.CO_CODE= ? AND B.YEAR = ?",[e,s],function(s,o){n.serialize(function(){var s=0;o.forEach(function(t){var a=t.BILLID,A=t.COL_HEAD,C="UPDATE COL_REG SET "+A+" = "+t.BILL_AMT+" WHERE CO_CODE = ? AND BILLID = ?";n.run(C,[e,a],function(e,t){return e?(n.close(),E(null,!1)):++s==o.length?(n.close(),E(null,!0)):void 0})})})})})})}var a=E(0),A=a.Router(),C=E(2).verbose(),r=E(1),D=E(6),T=E(7);A.get("/",function(e,s,E){s.render("tallyimport")}),A.get("/listall",function(e,s,E){var n=new C.Database(r.database,C.OPEN_READWRITE,function(E){E&&s.json(E.message),n.all("SELECT C.GRP_CODE, A.AC_CODE, C.AC_NAME, B.COMPANY, A.BILL_NO, A.BILL_DT, A.TOT_AMT\n              , (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END) AS RCPT_AMT \n              , (A.TOT_AMT- (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END)) AS BAL_AMT \n              FROM VOUCHERS A, COMPANY B, ACC_MAST C\n              WHERE A.CO_CODE = B.CO_CODE\n              AND A.AC_CODE=C.AC_CODE\n              AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n              AND B.CO_CODE = ?\n              ORDER BY 1, 2",[e.user.DEFAULT_CO],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),A.post("/allOS",function(e,s,E){var n=e.body.grouplist,o="SELECT C.GRP_CODE, A.AC_CODE, C.AC_NAME, B.COMPANY, A.BILL_NO, A.BILL_DT, A.TOT_AMT\n              , (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END) AS RCPT_AMT \n              , (A.TOT_AMT- (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END)) AS BAL_AMT \n              FROM VOUCHERS A, COMPANY B, ACC_MAST C\n              WHERE A.CO_CODE = B.CO_CODE\n              AND A.AC_CODE=C.AC_CODE\n              AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n              <<SPECIFICGROUPOPTION>>\n              ORDER BY 1, 2";o=2==e.body.datascope?o.replace("<<SPECIFICGROUPOPTION>>","AND GRP_CODE IN "+n):o.replace("<<SPECIFICGROUPOPTION>>"," ");var t=new C.Database(r.database,C.OPEN_READWRITE,function(e){e&&s.json(e.message),t.all(o,[],function(e,E){e?s.json(e.message):s.json(E)})});t.close()});var O=function(e,s,E,n){var o=new C.Database(r.database,C.OPEN_READWRITE,function(t){if(t)return n(null,0);o.get("SELECT BILLID FROM VOUCHERS WHERE CO_CODE = ? AND BILL_NO = ? AND BILL_DT = ?",[e,s,E],function(e,s){return s?n(null,s.BILLID):n(null,0)})})};A.post("/billimport",function(e,s,E){var o=e.body;"Add"==o.ACT?n(o,function(e,E){if(E)var n=new C.Database(r.database,C.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):n.serialize(function(){n.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,E){var t=E.NEWBILLID,a=getFinYear(new Date(o.BILL_DATE));n.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR = ?",[o.CO_CODE,a],function(e,E){for(var A=E&&E.NEWBILL_NO?E.NEWBILL_NO:1,C=o.Transactions,r=0,D=0;D<C.length;D++)r+=C[D].Amount;var T=r,O=0,R="";n.get("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[o.AC_CODE,o.CO_CODE],function(e,E){if(E){if(E.BAL_AMT>0){O=E.BAL_AMT,R=E.BILLID;var D={};D.TRCD="OST",D.SUBCD="",D.REMARKS="Bill No : "+E.BILL_NO+" dtd :  "+E.BILL_DT,D.Amount=E.BAL_AMT,C.splice(0,0,D),r+=O,T=r}}else O=0;n.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ? )",[t,o.CO_CODE,A,o.BILL_DATE,o.AC_CODE,T,r,a,R],function(e,E){n.serialize(function(){isError=!1;for(var E=0;E<C.length;E++){var a=C[E].TRCD,r=C[E].SUBCD,D=C[E].REMARKS,T=C[E].Amount;n.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[t,o.CO_CODE,A,o.BILL_DATE,a,r,D,T],function(e,s){isError=!!e})}isError?s.json({ResponseValue:e.message}):(n.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[R],function(e,s){isError=!!e,errMsg=e?e.message:""}),s.json({ResponseValue:"Bill Created!"}))})})})})})})});else s.json({ResponseValue:"Errors in Data!"})}):O(o.CO_CODE,o.BILL_NO,o.BILL_DATE,function(e,E){var t=E;t>0?"Delete"==o.ACT?s.json({ResponseValue:"Bill deleted!"}):n(o,function(e,E){if(E){console.log("updating the bill");var n=new C.Database(r.database,C.OPEN_READWRITE,function(e){n.get("SELECT 'X' FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ? AND CLIND = 'Y' ",[o.CO_CODE,t],function(e,E){if(E)s.json({ResponseValue:"Closed Bill cannot be updated!"});else{for(var a=0,A=o.Transactions,C=0;C<A.length;C++)a+=A[C].Amount;var r=a;n.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE = ? AND BILLID = ?",[r,a,o.CO_CODE,t],function(e,s){if(e)isError=!0,errMsg=e.message;else{n.run("DELETE FROM TRANSACT WHERE CO_CODE = ? AND BILLID = ? AND TRCD <> 'OST' ",[o.CO_CODE,t],function(e,s){e?(isError=!0,errMsg=e.message):n.serialize(function(){for(var e=0;e<A.length;e++){var s=A[e].TRCD,E=A[e].SUBCD,a=A[e].Amount;n.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ? )",[t,o.CO_CODE,o.BILL_NO,o.BILL_DATE,s,E,a],function(e,E){console.log(s),e?(isError=!0,errMsg=e.message,console.log(errMsg)):isError=!1})}n.get("SELECT SUM(BILL_AMT) AS TOTAL FROM TRANSACT WHERE CO_CODE= ? AND BILLID = ?",[o.CO_CODE,t],function(e,s){billtotAmt=s.TOTAL,billtotAmt1=s.TOTAL,n.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE= ? AND BILLID = ?",[billtotAmt,billtotAmt1,o.CO_CODE,t],function(e,s){isError=!!e,errMsg=e?e.message:"",console.log("database Closed"),n.close()})})})})}})}})});s.json({ResponseValue:"Bill updated!"})}else s.json({ResponseValue:"Errors in Data!"})}):s.json({ResponseValue:"Bill not found!"})})}),A.post("/billexport",function(e,s,E){var n=e.body.CO_CODE,a=e.body.YEAR;o(e.body,function(e,E){E?t(n,a,function(e,E){if(E)var n=new C.Database(r.database,C.OPEN_READWRITE,function(e){s.statusCode=200,s.setHeader("Content-Type","text/csv");var E="CO_CODE, BILL_NO, BILL_DT, AC_NAME, AC_CODE ";n.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,o){k=0,o.forEach(function(e){E=E+","+e.COL_HEAD,++k==o.length&&(E+=endOfLine)}),n.all("SELECT A.CO_CODE AS CCODE, B.BILL_NO, B.BILL_DT, C.AC_NAME, B.AC_CODE, A.* FROM COL_REG A, VOUCHERS B, ACC_MAST C WHERE A.CO_CODE=B.CO_CODE AND A.BILLID=B.BILLID AND B.AC_CODE = C.AC_CODE",[],function(e,o){e?(n.close(),s.write("no data found"),s.end()):(s.write(E),i=0,o.forEach(function(e){var E="";for(var t in e)if("CO_CODE"!=t&&"BILLID"!=t){var a=null==e[t]?"0":e[t];E=E+a+","}E+=endOfLine,s.write(E),++i==o.length&&(n.close(),s.end())}))})})});else s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end()}):(s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end())})}),A.post("/osemail",function(e,s,E){console.log("sending emails for outstanding");var n=D.createTransport({service:"gmail",auth:{xoauth2:T.creatXOAuth2Generator({user:"nitin.tandel16@gmail.com",clientId:"857597703416-5gs7tb40dduvr4pa8j97anmqqjml1p79.apps.googleusercontent.com",clientSecret:"xT-ed_l4-wX_6uiYJdNNpUcM",refreshToken:""})}}),o={from:"nitin.tandel16@gmail.com",to:"nitin_tandel16@yahoo.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"};n.sendMail(o,function(e,E){e?(console.log(e),s.json(e)):(console.log("Email sent: "+E.response),s.json({ResponseValue:"sent emails!"}))})}),e.exports=A},function(e,s,E){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e){var s=e.replace(/&/g,"&amp;");return s=s.replace(/'/g,"&apos;"),s=s.replace(/"/g,"&quot;")}var t=E(43),a=n(t),A=E(44),C=n(A),r=E(45),D=n(r),T=function(){var e=(0,D.default)(C.default.mark(function e(s,E,n,t){var a,A,r,D,T,O,R,u,L,i,I,d,N,f,g,B;return C.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=l,a=a.replace(/<<TALLY_CO_NAME>>/g,o(E.TALLY_CO_NAME)),A=o(E.TALLY_CASH_LEDGER),r=o(E.TALLY_BANK_LEDGER),D=o(E.FEES_LEDGER),T=0;case 6:if(!(T<n.length)){e.next=42;break}return O="AVS_GUID_"+n[T].BILLID,R=c,R=R.replace(/<<REMOTE_ID>>/g,O),R=R.replace(/<<RCPT_DATE>>/g,"20180401"),R=R.replace(/<<TALLY_GUID>>/g,O),u="R",R=R.replace(/<<BILL_NO>>/g,n[T].BILL_NO),0!=n[T].CASH_AMT?(R=R.replace(/<<CASH_BANK_LEDGER>>/g,A),u+="CSH_"):(R=R.replace(/<<CASH_BANK_LEDGER>>/g,r),u+="CSH_"),u+=n[T].BILL_NO,R=R.replace(/<<RCPT_NO>>/g,u),R=R.replace(/<<VOUCHER_KEY>>/g,n[T].BILLID),R=R.replace(/<<FEES_LEDGER>>/g,D),R=R.replace(/<<RCPT_AMOUNT>>/g,n[T].RCPT_AMOUNT),R=R.replace(/<<PARTY_NAME>>/g,o(n[T].AC_NAME)),a=a+R+S,L=n[T].BILLID,i=n[T].TALLY_FLG_TYPE,I=1==i?"UPDATE VOUCHERS SET TALLY_EXP_FLG1 = 9 WHERE BILLID = "+L:"UPDATE VOUCHERS SET TALLY_EXP_FLG2 = 9 WHERE BILLID = "+L,d={url:s,body:a,headers:{"Content-Type":"text/xml"}},e.next=28,tallypostreq(d);case 28:if(N=e.sent,f=!1,g=N.body,B=g.search("<CREATED>1</CREATED>"),-1==B&&(B=g.search("<ALTERED>1</ALTERED>")),-1==B){e.next=38;break}return e.next=36,_.runAsync(I);case 36:e.next=39;break;case 38:console.log(N.body);case 39:T++,e.next=6;break;case 42:t("OK");case 43:case"end":return e.stop()}},e,this)}));return function(s,E,n,o){return e.apply(this,arguments)}}(),O=E(0),R=O.Router(),u=E(2).verbose(),L=E(1),i=E(5),_=new u.Database(L.database,u.OPEN_READWRITE,function(e){}),l="<ENVELOPE>\n <HEADER>\n  <TALLYREQUEST>Import Data</TALLYREQUEST>\n </HEADER>\n <BODY>\n  <IMPORTDATA>\n   <REQUESTDESC>\n    <REPORTNAME>All Masters</REPORTNAME>\n    <STATICVARIABLES>\n     <SVCURRENTCOMPANY><<TALLY_CO_NAME>></SVCURRENTCOMPANY>\n    </STATICVARIABLES>\n   </REQUESTDESC>\n   <REQUESTDATA> ",S="</REQUESTDATA></IMPORTDATA></BODY></ENVELOPE>",c='<TALLYMESSAGE xmlns:UDF="TallyUDF">\n     <VOUCHER REMOTEID="<<REMOTE_ID>>" VCHTYPE="Receipt" ACTION="ALTER" OBJVIEW="Accounting Voucher View">\n      <DATE><<RCPT_DATE>></DATE>\n      <GUID><<TALLY_GUID>></GUID>\n      <NARRATION>For Bill No: <<BILL_NO>></NARRATION>\n      <VOUCHERTYPENAME>Receipt</VOUCHERTYPENAME>\n      <VOUCHERNUMBER><<RCPT_NO>></VOUCHERNUMBER>\n      <PARTYLEDGERNAME><<CASH_BANK_LEDGER>></PARTYLEDGERNAME>\n      <PERSISTEDVIEW>Accounting Voucher View</PERSISTEDVIEW>\n      <ISOPTIONAL>No</ISOPTIONAL>\n      <EFFECTIVEDATE><<RCPT_DATE>></EFFECTIVEDATE>\n      <ALTERID> 145</ALTERID>\n      <ISCANCELLED>No</ISCANCELLED>\n      <HASCASHFLOW>Yes</HASCASHFLOW>\n      <ISPOSTDATED>No</ISPOSTDATED>\n      <MASTERID> 48</MASTERID>\n      <VOUCHERKEY><<VOUCHER_KEY>></VOUCHERKEY>\n      <ALLLEDGERENTRIES.LIST>\n       <LEDGERNAME><<FEES_LEDGER>></LEDGERNAME>\n       <ISDEEMEDPOSITIVE>No</ISDEEMEDPOSITIVE>\n       <LEDGERFROMITEM>No</LEDGERFROMITEM>\n       <REMOVEZEROENTRIES>No</REMOVEZEROENTRIES>\n       <ISPARTYLEDGER>No</ISPARTYLEDGER>\n       <ISLASTDEEMEDPOSITIVE>No</ISLASTDEEMEDPOSITIVE>\n       <AMOUNT><<RCPT_AMOUNT>></AMOUNT>\n       <CATEGORYALLOCATIONS.LIST>\n        <CATEGORY>Primary Cost Category</CATEGORY>\n        <ISDEEMEDPOSITIVE>No</ISDEEMEDPOSITIVE>\n        <COSTCENTREALLOCATIONS.LIST>\n         <NAME><<PARTY_NAME>></NAME>\n         <AMOUNT><<RCPT_AMOUNT>></AMOUNT>\n        </COSTCENTREALLOCATIONS.LIST>\n       </CATEGORYALLOCATIONS.LIST>\n      </ALLLEDGERENTRIES.LIST>\n      <ALLLEDGERENTRIES.LIST>\n       <LEDGERNAME><<CASH_BANK_LEDGER>></LEDGERNAME>\n       <ISDEEMEDPOSITIVE>Yes</ISDEEMEDPOSITIVE>\n       <LEDGERFROMITEM>No</LEDGERFROMITEM>\n       <REMOVEZEROENTRIES>No</REMOVEZEROENTRIES>\n       <ISPARTYLEDGER>Yes</ISPARTYLEDGER>\n       <ISLASTDEEMEDPOSITIVE>Yes</ISLASTDEEMEDPOSITIVE>\n       <AMOUNT>-<<RCPT_AMOUNT>></AMOUNT>\n      </ALLLEDGERENTRIES.LIST>\n     </VOUCHER>\n    </TALLYMESSAGE>';R.get("/",function(e,s,E){s.render("tallyexport")}),R.post("/SendCCtoTally",function(e,s,E){var n=e.user.DEFAULT_CO,t=(e.body.reExport,e.body.partylist),a="http://"+e.body.TALLYSERVER,A=e.body.exportscope,C=new u.Database(L.database,u.OPEN_READWRITE,function(e){e&&s.json(e.message),C.get("SELECT CO_CODE, COMPANY, TALLY_CO_NAME FROM COMPANY WHERE CO_CODE= ?",[n],function(e,E){var n="SELECT A.AC_CODE, A.AC_NAME, B.GRP_NAME FROM ACC_MAST A, GROUP_MAST B \n              WHERE A.GRP_CODE=B.GRP_CODE AND A.TALLY_EXP_FLG <> 9 \n              <<SELECTED_PARTIES>> ";n=2==A?n.replace(/<<SELECTED_PARTIES>>/g,"AND A.AC_CODE IN "+t):n.replace(/<<SELECTED_PARTIES>>/g," "),C.all(n,[],function(e,n){var t=l;t=t.replace(/<<TALLY_CO_NAME>>/g,o(E.TALLY_CO_NAME));for(var A=0;A<n.length;A++){var r='<TALLYMESSAGE xmlns:UDF="TallyUDF">\n     <COSTCENTRE NAME="<<PARTY_NAME>>" RESERVEDNAME="">\n      <GUID>AVSolution-<<PARTY_CODE>></GUID>\n      <PARENT/>\n      <CATEGORY>Primary Cost Category</CATEGORY>\n      <REVENUELEDFOROPBAL>No</REVENUELEDFOROPBAL>\n      <ISUPDATINGTARGETID>No</ISUPDATINGTARGETID>\n      <ASORIGINAL>Yes</ASORIGINAL>\n      <AFFECTSSTOCK>No</AFFECTSSTOCK>\n      <FORPAYROLL>No</FORPAYROLL>\n      <FORJOBCOSTING>No</FORJOBCOSTING>\n      <ISEMPLOYEEGROUP>No</ISEMPLOYEEGROUP>\n      <SORTPOSITION> 1000</SORTPOSITION>\n      <LANGUAGENAME.LIST>\n       <NAME.LIST TYPE="String">\n        <NAME><<PARTY_NAME>></NAME>\n        <NAME><<PARTY_CODE>></NAME>\n       </NAME.LIST>\n      </LANGUAGENAME.LIST>\n     </COSTCENTRE>\n    </TALLYMESSAGE>';r=r.replace(/<<PARTY_NAME>>/g,o(n[A].AC_NAME)),r=r.replace(/<<PARTY_CODE>>/g,o(n[A].AC_CODE)),t+=r}t+=S,C.close(),i.post({url:a,body:t,headers:{"Content-Type":"text/xml"}},function(e,E,n){e||200!=E.statusCode?s.status(202).json({message:"Error while exporting data!",error:"Yes"}):s.status(202).json({message:"Data exported successfully!",error:"No"}),s.end()})})})})}),R.post("/SendtoTally",function(e,s,E){var n=e.user.DEFAULT_CO,o=e.body.FROM_DT,t=e.body.TO_DT,a=e.body.reExport,A=(e.body.datascope,e.body.partylist,e.body.grouplist),C="http://"+e.body.TALLYSERVER,r="SELECT A.BILLID, A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME, A.BILL_NO, A.TOT_AMT, REPLACE(A.RCPT_DATE,'-','') AS RCPTDT, CASH1 AS CASH_AMT, CHEQUE1 AS CHQ_AMT , (CASH1 + CHEQUE1 ) AS RCPT_AMOUNT, TALLY_EXP_FLG1 AS TALLY_FLG, 1 AS TALLY_FLG_TYPE \n                  FROM VOUCHERS A, ACC_MAST B\n                  WHERE A.AC_CODE= B.AC_CODE AND A.RCPT_DATE BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n                  AND A.CO_CODE = <<CO_CODE>>\n                  AND CASH1 + CHEQUE1 > 0\n                  <<CHECKTALLYFLAG1>>\n                  <<SPECIFICGROUPOPTION>>\n                  <<SPECIFIC_PARTYOPTION>>\n                  UNION \n                  SELECT A.BILLID, A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME, A.BILL_NO, A.TOT_AMT, REPLACE(A.RCPT_DATE2, '-', '') AS RCPTDT, CASH2 AS CASH_AMT, CHEQUE2 AS CHQ_AMT, (CASH2 + CHEQUE2 ) AS RCPT_AMOUNT, TALLY_EXP_FLG2 AS TALLY_FLG, 2 AS TALLY_FLG_TYPE \n                  FROM VOUCHERS A, ACC_MAST B\n                  WHERE A.AC_CODE = B.AC_CODE AND A.RCPT_DATE2 BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n                  AND CASH2 + CHEQUE2 > 0\n                  AND A.CO_CODE = <<CO_CODE>>\n                  <<CHECKTALLYFLAG2>>\n                  <<SPECIFICGROUPOPTION>>\n                  <<SPECIFIC_PARTYOPTION>>\n                  ORDER BY 1, 7 ";r=r.replace(/<<FROM_DT>>/g,o),r=r.replace(/<<TO_DT>>/g,t),r=r.replace(/<<CO_CODE>>/g,n),r=r.replace(/<<SPECIFIC_PARTYOPTION>>/g,""),a?(r=r.replace(/<<CHECKTALLYFLAG1>>/g,""),r=r.replace(/<<CHECKTALLYFLAG2>>/g,"")):(r=r.replace(/<<CHECKTALLYFLAG1>>/g,"AND TALLY_EXP_FLG1 <> 9"),r=r.replace(/<<CHECKTALLYFLAG2>>/g,"AND TALLY_EXP_FLG2 <> 9")),r=2==e.body.datascope?r.replace(/<<SPECIFICGROUPOPTION>>/g,"AND B.GRP_CODE IN "+A):r.replace(/<<SPECIFICGROUPOPTION>>/g,"");var D=new u.Database(L.database,u.OPEN_READWRITE,function(e){e&&s.json(e.message),D.get("SELECT CO_CODE, COMPANY, TALLY_CO_NAME, TALLY_CASH_LEDGER, TALLY_BANK_LEDGER, FEES_LEDGER FROM COMPANY WHERE CO_CODE= ?",[n],function(e,E){e?s.json(e.message):D.all(r,[],function(e,n){e?s.json(e.message):T(C,E,n,function(e){"OK"==e?s.status(202).json({message:"Data exported successfully!",error:"No"}):s.status(202).json({message:"Error while exporting data!",error:"Yes"}),s.end()})})})});D.close()}),tallypostreq=function(e){return new a.default(function(s,E){i.post(e,function(e,n){e?E(e):s(n)})})},_.runAsync=function(e){var s=this;return new a.default(function(E,n){s.run(e,function(e,s){e?n(e):E(s)})})},R.get("/TallyConfig",function(e,s,E){var n=new u.Database(L.database,u.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all("SELECT * FROM av_config WHERE config_field LIKE 'TALLY%' ",[],function(e,E){e?s.json(e.message):s.json(E)})});n.close()}),R.get("/TallyCoConfig",function(e,s,E){var n=e.user.DEFAULT_CO,o=new u.Database(L.database,u.OPEN_READWRITE,function(e){e&&s.json(e.message),o.get("SELECT CO_CODE, COMPANY, TALLY_CO_NAME, TALLY_CASH_LEDGER, TALLY_BANK_LEDGER FROM COMPANY WHERE CO_CODE= ?",[n],function(e,E){e?s.json(e.message):s.json(E)})});o.close()}),R.post("/UpdateTServer",function(e,s,E){var n=e.body.TALLYSERVER,o=new u.Database(L.database,u.OPEN_READWRITE,function(e){if(e)s.status(202).json({message:"Database Error ! not able to Tally server value.",error:"Yes"});else{o.run("UPDATE av_config SET config_value_str = ? WHERE config_field = 'TALLYSERVER'",[n],function(e,E){e?s.status(202).json({message:"Database Error ! not able to Tally server value.",error:"Yes"}):s.status(202).json({message:"Tally Server Value saved successfully!",error:"No"}),o.close(),s.end()})}})}),e.exports=R},function(e,s){e.exports=require("babel-runtime/core-js/promise")},function(e,s){e.exports=require("babel-runtime/regenerator")},function(e,s){e.exports=require("babel-runtime/helpers/asyncToGenerator")}]);