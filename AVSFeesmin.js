var express=require("express"),path=require("path"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),exphbs=require("express-handlebars"),handlebars=require("handlebars"),expressValidator=require("express-validator"),flash=require("connect-flash"),session=require("express-session"),passport=require("passport"),LocalStrategy=require("passport-local").Strategy,config=require("./config"),port=process.env.PORT||config.serverport,sqlite3=require("sqlite3").verbose(),db=new sqlite3.Database("./db/fees.db",sqlite3.OPEN_READWRITE,function(e){e&&console.error(e.message),console.log("Connected to the fees database."),db.close()}),routes=require("./routes/index"),menus=require("./routes/menus"),users=require("./routes/users"),dbdata=require("./routes/dbdata"),company=require("./routes/company"),groups=require("./routes/groups"),parties=require("./routes/parties"),trcds=require("./routes/trcds"),trcdsubs=require("./routes/trcdsubs"),bills=require("./routes/bills"),receipts=require("./routes/receipts"),outstandings=require("./routes/outstandings"),billreg=require("./routes/billreg"),ledgers=require("./routes/ledgers"),rcptreg=require("./routes/rcptreg"),app=express();handlebars.registerHelper("if_eq",function(e,s,r){return e==s?r.fn(this):r.inverse(this)}),app.set("views",path.join(__dirname,"views")),app.engine("handlebars",exphbs({defaultLayout:"layout"})),app.set("view engine","handlebars"),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.use(cookieParser()),app.use(express.static(path.join(__dirname,"public"))),app.use(session({secret:"secret",saveUninitialized:!0,resave:!0})),app.use(passport.initialize()),app.use(passport.session()),app.use(expressValidator({errorFormatter:function(e,s,r){for(var a=e.split("."),p=a.shift();a.length;)p+="["+a.shift()+"]";return{param:p,msg:s,value:r}}})),app.use(flash()),app.use(function(e,s,r){s.locals.success_msg=e.flash("success_msg"),s.locals.error_msg=e.flash("error_msg"),s.locals.error=e.flash("error"),s.locals.user=e.user||null,r()}),app.use("/",routes),app.use("/menus",menus),app.use("/users",users),app.use("/dbdata",dbdata),app.use("/company",company),app.use("/groups",groups),app.use("/parties",parties),app.use("/trcds",trcds),app.use("/trcdsubs",trcdsubs),app.use("/bills",bills),app.use("/receipts",receipts),app.use("/outstandings",outstandings),app.use("/billreg",billreg),app.use("/ledgers",ledgers),app.use("/rcptreg",rcptreg),app.set("port",port),app.listen(app.get("port"),function(){console.log("Server started on port "+app.get("port"))});