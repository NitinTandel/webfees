!function(e){function s(o){if(n[o])return n[o].exports;var E=n[o]={i:o,l:!1,exports:{}};return e[o].call(E.exports,E,E.exports,s),E.l=!0,E.exports}var n={};s.m=e,s.c=n,s.d=function(e,n,o){s.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},s.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(n,"a",n),n},s.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},s.p="",s(s.s=9)}([function(e,s){e.exports=require("express")},function(e,s,n){"use strict";n(7);e.exports={baseurl:"http://localhost",serverport:4e3,tokenexp:3600,secret:"avsnitin",database:"./db/fees.db",apppath:"C:/NitinWork/NodeProjects/WebFees"}},function(e,s){e.exports=require("sqlite3")},function(e,s){e.exports=require("passport")},function(e,s){e.exports=require("passport-local")},function(e,s){e.exports=require("nodemailer")},function(e,s){e.exports=require("xoauth2")},function(e,s){e.exports=require("path")},function(e,s){e.exports=require("request")},function(e,s,n){e.exports=n(10)},function(e,s,n){"use strict";var o=n(0),E=n(7),t=n(11),a=n(12),r=n(13),C=n(14),A=n(15),D=n(16),T=n(17),O=n(3),R=(n(4).Strategy,n(1)),u=process.env.PORT||R.serverport,i=n(2).verbose(),l=new i.Database("./db/fees.db",i.OPEN_READWRITE,function(e){e&&console.error(e.message),console.log("Connected to the fees database."),l.close()}),L=n(18),_=n(19),c=n(20),d=n(23),S=n(24),I=n(25),N=n(26),f=n(27),g=n(28),B=n(29),b=n(36),m=n(37),M=n(38),U=n(39),p=n(40),P=E.join(R.apppath,"views"),y=E.join(R.apppath,"public"),j=o();C.registerHelper("if_eq",function(e,s,n){return e==s?n.fn(this):n.inverse(this)}),j.set("views",P),j.engine("handlebars",r({defaultLayout:"layout"})),j.set("view engine","handlebars"),j.use(a.json()),j.use(a.urlencoded({extended:!1})),j.use(t()),j.use(o.static(y)),j.use(T({secret:"secret",saveUninitialized:!0,resave:!0})),j.use(O.initialize()),j.use(O.session()),j.use(A({errorFormatter:function(e,s,n){for(var o=e.split("."),E=o.shift(),t=E;o.length;)t+="["+o.shift()+"]";return{param:t,msg:s,value:n}}})),j.use(D()),j.use(function(e,s,n){s.locals.success_msg=e.flash("success_msg"),s.locals.error_msg=e.flash("error_msg"),s.locals.error=e.flash("error"),s.locals.user=e.user||null,n()}),j.use("/",L),j.use("/menus",_),j.use("/users",c),j.use("/dbdata",d),j.use("/company",S),j.use("/groups",I),j.use("/parties",N),j.use("/trcds",f),j.use("/trcdsubs",g),j.use("/bills",B),j.use("/receipts",b),j.use("/outstandings",m),j.use("/billreg",M),j.use("/ledgers",U),j.use("/rcptreg",p),j.set("port",u),j.listen(j.get("port"),function(){console.log("Server started on port "+j.get("port"))})},function(e,s){e.exports=require("cookie-parser")},function(e,s){e.exports=require("body-parser")},function(e,s){e.exports=require("express-handlebars")},function(e,s){e.exports=require("handlebars")},function(e,s){e.exports=require("express-validator")},function(e,s){e.exports=require("connect-flash")},function(e,s){e.exports=require("express-session")},function(e,s,n){"use strict";var o=n(0),E=o.Router();E.get("/",function(e,s){s.render("index")}),E.get("/about",function(e,s){s.render("about")}),e.exports=E},function(e,s,n){"use strict";var o=n(0),E=o.Router();E.get("/menuMasters",function(e,s){s.render("menuMasters")}),E.get("/GrpMast",function(e,s){s.render("../groups")}),E.get("/menuTrans",function(e,s){s.render("menuTrans")}),E.get("/menuIntegration",function(e,s){s.render("menuIntegration")}),E.get("/menuReports",function(e,s){s.render("menuReports")}),E.get("/menuSetting",function(e,s){s.render("menuSetting")}),E.get("/users/login",function(e,s){s.render("login")}),e.exports=E},function(e,s,n){"use strict";function o(e,s,n){if(e.isAuthenticated())return n();var o="Authetication Failed !";console.log(o),s.json({message:o})}var E=n(21),t=function(e){return e&&e.__esModule?e:{default:e}}(E),a=n(0),r=a.Router(),C=n(2).verbose(),A=(n(8),n(1)),D=n(3),T=n(4).Strategy,O=n(22),R=O.genSaltSync(10);r.get("/listall",o,function(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT USERID, USER_NAME, USER_EMAIL, ROLE FROM USERS",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),r.get("/details/:Id",function(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT * FROM USERS WHERE USERID = ?",[e.params.Id],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),r.get("/login",function(e,s,n){s.render("login")}),r.post("/login",D.authenticate("local",{successRedirect:"/",failureRedirect:"/",failureFlash:!0}),function(e,s){s.redirect("/dashboard")}),D.use(new T(function(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(E){E?res.json(E.message):o.get("SELECT USERID, SALT FROM USERS WHERE USERID = '"+e+"'",function(E,t){if(!t)return n(null,!1,{message:"Unknown User "+e});var a=O.hashSync(s,t.SALT);o.get("SELECT USERID, USER_NAME FROM USERS WHERE USERID = ? AND PASS = ?",e,a,function(e,s){return s?n(null,s):n(null,!1,{message:"Invalid password !!"})})})});o.close()})),D.serializeUser(function(e,s){s(null,e.USERID)}),D.deserializeUser(function(e,s){var n=new C.Database(A.database,C.OPEN_READWRITE,function(o){o?res.json(o.message):n.get("SELECT A.USERID, A.USER_NAME, A.ROLE, A.USER_EMAIL, A.DEFAULT_CO, B.COMPANY, A.DEFAULT_YEAR FROM users A LEFT JOIN COMPANY B ON A.DEFAULT_CO=B.CO_CODE WHERE userid = ?",e,function(e,n){return n?s(null,n):s(null,!1)})});n.close()}),r.get("/checkduplicateUser/:id",function(e,s){var n=new C.Database(A.database,C.OPEN_READWRITE,function(o){o?s.json(o.message):n.get("SELECT * FROM users WHERE userid = ?",+e.params.Id,function(e,n){return n?s.json({message:"Error"}):s.json({message:"OK"})})});n.close()}),r.get("/logout",function(e,s){e.logout(),e.flash("success_msg","You are logged out"),s.redirect("/users/login")}),r.get("/manageusers",function(e,s,n){s.render("manageusers")}),r.get("/register",function(e,s){s.render("register")}),r.post("/register",function(e,s){var n=e.body.userid,o=e.body.username,E=e.body.email,t=e.body.role,a=e.body.password,r=(e.body.password2,e.body.defaultCoID),D=e.body.defaultYear,T=new C.Database(A.database,C.OPEN_READWRITE,function(C){C?s.status(500).json({message:C.message,error:"Yes"}):T.get("SELECT * FROM users WHERE userid = ?",+e.params.Id,function(C,A){if(A)s.status(500).json({message:"Cannot add ! UserID :"+e.params.Id+" already exists!",error:"Yes"});else{var u=O.hashSync(a,R);T.run("INSERT INTO USERS (USERID, USER_NAME, PASS, SALT, USER_EMAIL, ROLE, DEFAULT_CO, DEFAULT_YEAR) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[n,o,u,R,E,t,r,D],function(e,n){e?s.status(500).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User Added successfully!",error:"Yes"}),s.end()})}})});T.close()}),r.get("/userprofile",function(e,s,n){s.render("userprofile")}),r.post("/updateUser",function(e,s){var n=e.body.USERID,o=e.body.USER_NAME,E=e.body.USER_EMAIL,t=e.body.ROLE,a=e.body.selectedCOName,r=e.body.DEFAULT_CO,D=e.body.DEFAULT_YEAR,T=new C.Database(A.database,C.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):(T.get("SELECT CO_CODE, COMPANY FROM COMPANY WHERE COMPANY = ? LIMIT 1",a,function(e,s){s&&(r=s.CO_CODE)}),T.get("SELECT * FROM users WHERE USERID = ?",n,function(e,a){if(a){T.run("UPDATE USERS SET USER_NAME = ?, USER_EMAIL = ?, ROLE = ?, DEFAULT_CO = ?, DEFAULT_YEAR = ? WHERE USERID = ?",[o,E,t,r,D,n],function(e,n){e?s.status(500).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User updated successfully!",error:"No"}),s.end()})}else s.status(500).json({message:"Cannot update! UserID : "+n+" does not exists!",error:"Yes"})}))});T.close()}),r.post("/forgot",function(e,s){if(console.log(e),e.isAuthenticated())return s.redirect("/");User.forgot(e,s,function(n){n?e.flash("error",n):e.flash("success","Please check your email for further instructions."),s.redirect("/")})}),r.post("/changepass",o,function(e,s){var o=e.body.USERID,E=e.body.cPwd1;e.body.cPwd2,n(8);e.checkBody("USERID","userid is required").notEmpty(),e.checkBody("cPwd1","Password is required").notEmpty(),e.checkBody("cPwd2","Passwords do not match").equals(e.body.cPwd1);var a=e.validationErrors();if(a){var r=a.map(function(e){return e.msg}),D=(0,t.default)(r);s.json({message:D,error:"Yes"})}else{var T=new C.Database(A.database,C.OPEN_READWRITE,function(e){if(e)s.status(500).json({message:e.message,error:"Yes"});else{var n=O.hashSync(E,R);T.run("UPDATE USERS SET PASS = ?, SALT = ? WHERE USERID = ?",[n,R,o],function(e,n){e?s.status(500).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Password changed successfully!",error:"No"}),s.end()})}});T.close()}}),r.post("/delete/:Id",function(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(n){n&&s.status(500).json({message:n.message,error:"Yes"});o.run("DELETE FROM USERS WHERE USERID = ?",[e.params.Id],function(n,o){n?s.status(500).json({message:n.message,error:"Yes"}):s.status(202).json({message:"user : '"+e.params.Id+"' deleted successfully !",error:"No"}),s.end()})});o.close()}),r.get("/changeCompany",function(e,s,n){s.render("changecompany")}),r.post("/updateCurrentCo",function(e,s){var n=e.user.USERID,o=(e.body[0].COMPANY,e.body[0].CO_CODE),E=new C.Database(A.database,C.OPEN_READWRITE,function(e){if(e)s.status(500).json({message:e.message,error:"Yes"});else{E.run("UPDATE USERS SET DEFAULT_CO = ? WHERE USERID = ?",[o,n],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User updated successfully!",error:"No"}),s.end(),E.close()})}})}),r.get("/changeYear",function(e,s,n){s.render("changeyear")}),r.post("/updateCurrentYr",function(e,s){var n=e.user.USERID,o=e.body[0],E=new C.Database(A.database,C.OPEN_READWRITE,function(e){if(e)s.status(202).json({message:e.message,error:"Yes"});else{E.run("UPDATE USERS SET DEFAULT_YEAR = ? WHERE USERID = ?",[o,n],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"User updated successfully!",error:"No"}),s.end(),E.close()})}})}),e.exports=r},function(e,s){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,s){e.exports=require("bcryptjs")},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);n(3),n(4).Strategy;E.post("/EXEC",function(e,s,n){var o={p1:e.body.cmdType,p2:e.body.sqlStmt},E=new t.Database(a.database,t.OPEN_READWRITE,function(e){if(e&&s.json(e.message),"SELECT"===o.p1)var n=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),n.all(o.p2,[],function(e,n){e?s.json(e.message):s.json(n)})});else"UPDATE"===o.p1?E.run(o.p2,[],function(e,n){e?s.status(500).json(e.message):s.status(202).json({message:"updated"}),s.end()}):"DELETE"===o.p1?E.run(o.p2,[],function(e,n){e?s.status(500).json(e.message):s.status(202).json({message:"deleted"}),s.end()}):"INSERT"===o.p1?E.run(o.p2,[],function(e,n){e?s.status(500).json(e.message):s.status(202).json({message:"Inserted"}),s.end()}):s.status(202).json({message:"Invalid params"})});E.close()}),e.exports=E},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);E.get("/",function(e,s,n){s.render("company")}),E.get("/listall",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT CO_CODE, COMPANY, EMAIL, TEL1 FROM COMPANY",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),E.get("/details/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT * FROM COMPANY WHERE CO_CODE = ?",[e.params.Id],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),E.get("/yearslist",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT YEAR FROM YEARS",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),E.post("/register",function(e,s){var n=e.body.CO_CODE,o=e.body.COMPANY,E=void 0===e.body.ADD1?"":e.body.ADD1,r=void 0===e.body.ADD2?"":e.body.ADD2,C=void 0===e.body.ADD3?"":e.body.ADD3,A=void 0===e.body.STATE?"":e.body.STATE,D=void 0===e.body.CITY_DIST?"":e.body.CITY_DIST,T=void 0===e.body.PIN?"":e.body.PIN,O=void 0===e.body.EMAIL?"":e.body.EMAIL,R=void 0===e.body.TEL1?"":e.body.TEL1,u=void 0===e.body.TEL2?"":e.body.TEL2,i=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):i.get("SELECT * FROM COMPANY WHERE CO_CODE = ?",[n],function(e,t){if(t)s.status(202).json({message:"Cannot add ! CompanyID already exists!",error:"Yes"});else{i.run("INSERT INTO COMPANY (CO_CODE, COMPANY, ADD1, ADD2, ADD3, STATE, CITY_DIST, PIN, EMAIL, TEL1, TEL2) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )",[n,o,E,r,C,A,D,T,O,R,u],function(e,n){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Company Added successfully!",error:"Yes"}),s.end(),i.close()})}i.close()})})}),E.post("/update",function(e,s){var n=e.body.CO_CODE,o=e.body.COMPANY,E=void 0===e.body.ADD1?"":e.body.ADD1,r=void 0===e.body.ADD2?"":e.body.ADD2,C=void 0===e.body.ADD3?"":e.body.ADD3,A=void 0===e.body.STATE?"":e.body.STATE,D=void 0===e.body.CITY_DIST?"":e.body.CITY_DIST,T=void 0===e.body.PIN?"":e.body.PIN,O=void 0===e.body.EMAIL?"":e.body.EMAIL,R=void 0===e.body.TEL1?"":e.body.TEL1,u=void 0===e.body.TEL2?"":e.body.TEL2,i=void 0===e.body.BANK_NAME?"":e.body.BANK_NAME,l=void 0===e.body.AC_NUM?"":e.body.AC_NUM,L=void 0===e.body.AC_TYPE?"":e.body.AC_TYPE,_=void 0===e.body.IFSC_CODE?"":e.body.IFSC_CODE,c=void 0===e.body.MICR?"":e.body.MICR,d=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):d.get("SELECT * FROM COMPANY WHERE CO_CODE = ?",[n],function(e,t){if(t){var a="UPDATE COMPANY SET COMPANY = ?, ADD1 = ?, ADD2 = ? , ADD3 = ?, STATE = ?, CITY_DIST = ?, PIN = ?, EMAIL = ?, TEL1 = ?, TEL2 = ? ,";a+=" BANK_NAME = ? , AC_NUM = ? , AC_TYPE = ? , IFSC_CODE = ? , MICR = ? ",a+=" WHERE CO_CODE = ? ",d.run(a,[o,E,r,C,A,D,T,O,R,u,i,l,L,_,c,n],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Company updated successfully!",error:"No"}),s.end(),d.close()})}else s.status(202).json({message:"Cannot update ! Company ID"+n+"does not exists!",error:"Yes"})})})}),E.post("/delete/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.status(500).json({message:n.message,error:"Yes"});o.run("DELETE FROM COMPANY WHERE CO_CODE = ?",[e.params.Id],function(n,E){n?s.status(500).json({message:n.message,error:"Yes"}):s.status(202).json({message:"Company : '"+e.params.Id+"' deleted successfully !",error:"No"}),o.close(),s.end()})})}),e.exports=E},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);E.get("/",function(e,s,n){s.render("groupmast")}),E.get("/listall",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT CO_CODE, GRP_CODE, GRP_NAME FROM GROUP_MAST ",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),E.get("/details/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT * FROM GROUP_MAST WHERE GRP_CODE = ? ",[e.params.Id],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),E.post("/register",function(e,s){var n=e.body.GRP_CODE,o=e.body.GRP_NAME,E=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,r=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,C=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,A=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,D=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):D.get("SELECT * FROM GROUP_MAST WHERE GRP_CODE = ? ",[n],function(e,t){if(t)s.status(202).json({message:"Cannot add ! Group ID already exists!",error:"Yes"});else{D.run("INSERT INTO GROUP_MAST (CO_CODE, GRP_CODE, GRP_NAME, ADDRESS1, ADDRESS2, ADDRESS3, ADDRESS4) VALUES ( ?, ?, ?, ?, ?, ?, ?)",[0,n,o,E,r,C,A],function(e,n){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Group Added successfully!",error:"Yes"}),s.end()})}})});D.close()}),E.post("/update",function(e,s){var n=e.body.GRP_CODE,o=e.body.GRP_NAME,E=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,r=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,C=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,A=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,D=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):D.get("SELECT 1 FROM GROUP_MAST WHERE GRP_CODE = ?",[n],function(e,t){if(t){D.run("UPDATE GROUP_MAST SET GRP_NAME = ?, ADDRESS1 = ?, ADDRESS2 = ? , ADDRESS3 = ?, ADDRESS4 = ? WHERE GRP_CODE = ?",[o,E,r,C,A,n],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Group updated successfully!",error:"No"}),s.end(),D.close()})}else s.status(202).json({message:'Cannot update ! Group ID "'+n+'" does not exists!',error:"Yes"})})})}),E.post("/delete/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.status(202).json({message:n.message,error:"Yes"});o.get("SELECT 1 FROM ACC_MAST WHERE GRP_CODE = ?",[e.params.Id],function(n,E){if(E)o.close(),s.status(202).json({message:"Cannot delete group '"+e.params.Id+"' already in use !",error:"Yes"}),s.end();else{o.run("DELETE FROM GROUP_MAST WHERE GRP_CODE = ?",[e.params.Id],function(n,E){n?s.status(202).json({message:n.message,error:"Yes"}):s.status(202).json({message:"Group : '"+e.params.Id+"' deleted successfully !",error:"No"}),o.close(),s.end()})}})})}),e.exports=E},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);E.get("/",function(e,s,n){s.render("partymast")}),E.get("/listall",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT A.CO_CODE, A.GRP_CODE, B.GRP_NAME, A.AC_CODE, A.AC_NAME FROM ACC_MAST A, GROUP_MAST B WHERE A.GRP_CODE=B.GRP_CODE ",[],function(e,n){e?s.json(e.message):s.json(n)}),o.close()})}),E.get("/namelist",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT AC_NAME, AC_CODE FROM ACC_MAST ",[],function(e,n){e?s.json(e.message):s.json(n)}),o.close()})}),E.get("/grouplist",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT GRP_CODE, GRP_NAME FROM GROUP_MAST",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),E.get("/currentGroupID/:Nm",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT GRP_CODE FROM GROUP_MAST WHERE GRP_NAME = ?",[e.params.Nm],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({GRP_NAME:"Incorrect Group"})})});o.close()}),E.get("/currentGroupNm/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT GRP_NAME FROM GROUP_MAST WHERE GRP_CODE = ?",[e.params.Id],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({GRP_CODE:"Incorrect Group"})})});o.close()}),E.get("/details/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT A.*, B.GRP_NAME FROM ACC_MAST A, GROUP_MAST B WHERE A.AC_CODE = ? AND A.GRP_CODE=B.GRP_CODE ",[e.params.Id],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),E.get("/currentPartyID/:Nm",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT AC_CODE FROM ACC_MAST WHERE AC_NAME = ?",[e.params.Nm],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({AC_NAME:"Incorrect Party"})})});o.close()}),E.post("/register",function(e,s){var n=e.body.AC_CODE,o=e.body.GRP_CODE,E=e.body.AC_NAME,r=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,C=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,A=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,D=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,T=void 0===e.body.OFF_TEL1?"":e.body.OFF_TEL1,O=void 0===e.body.OFF_TEL2?"":e.body.OFF_TEL2,R=void 0===e.body.RES_TEL1?"":e.body.RES_TEL1,u=void 0===e.body.RES_TEL2?"":e.body.RES_TEL2,i=void 0===e.body.PAN1?"":e.body.PAN1,l=void 0===e.body.PAN2?"":e.body.PAN2,L=void 0===e.body.CLOSED?"":e.body.CLOSED,_=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(202).json({message:e.message,error:"Yes"}):_.get("SELECT * FROM ACC_MAST WHERE AC_CODE = ? ",[n],function(e,t){if(t)s.status(202).json({message:"Cannot add ! Party ID already exists!",error:"Yes"});else{var a="INSERT INTO ACC_MAST (CO_CODE, AC_CODE, GRP_CODE, AC_NAME, ADDRESS1, ADDRESS2, ADDRESS3, ADDRESS4, OFF_TEL1, OFF_TEL2, RES_TEL1, RES_TEL2, PAN1, PAN2, CLOSED) ";a+=" VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )",_.run(a,[0,n,o,E,r,C,A,D,T,O,R,u,i,l,L],function(e,n){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Party Added successfully!",error:"Yes"}),s.end()})}})});_.close()}),E.post("/update",function(e,s){var n=e.body.AC_CODE,o=e.body.GRP_CODE,E=e.body.AC_NAME,r=void 0===e.body.ADDRESS1?"":e.body.ADDRESS1,C=void 0===e.body.ADDRESS2?"":e.body.ADDRESS2,A=void 0===e.body.ADDRESS3?"":e.body.ADDRESS3,D=void 0===e.body.ADDRESS4?"":e.body.ADDRESS4,T=void 0===e.body.OFF_TEL1?"":e.body.OFF_TEL1,O=void 0===e.body.OFF_TEL2?"":e.body.OFF_TEL2,R=void 0===e.body.RES_TEL1?"":e.body.RES_TEL1,u=void 0===e.body.RES_TEL2?"":e.body.RES_TEL2,i=void 0===e.body.PAN1?"":e.body.PAN1,l=void 0===e.body.PAN2?"":e.body.PAN2,L=void 0===e.body.CLOSED?"":e.body.CLOSED,_=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):_.get("SELECT 1 FROM ACC_MAST WHERE AC_CODE = ?",[n],function(e,t){if(t){_.run("UPDATE ACC_MAST SET AC_NAME = ?, GRP_CODE = ?, ADDRESS1 = ?, ADDRESS2 = ? , ADDRESS3 = ?, ADDRESS4 = ?, OFF_TEL1=?, OFF_TEL2=?, RES_TEL1=?, RES_TEL2=? , PAN1= ?, PAN2=? , CLOSED= ? WHERE AC_CODE = ?",[E,o,r,C,A,D,T,O,R,u,i,l,L,n],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Party updated successfully!",error:"No"}),s.end()})}else s.status(202).json({message:'Cannot update ! Party ID "'+o+'" does not exists!',error:"Yes"})})});_.close()}),E.post("/delete/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.status(202).json({message:n.message,error:"Yes"});o.get("SELECT 1 FROM VOUCHERS WHERE AC_CODE = ?",[e.params.Id],function(n,E){if(E)s.status(202).json({message:'Cannot delete ! one or more bills exists for Party ID "'+e.params.Id+'" !',error:"Yes"});else{o.run("DELETE FROM ACC_MAST WHERE AC_CODE = ?",[e.params.Id],function(n,E){n?s.status(202).json({message:n.message,error:"Yes"}):s.status(202).json({message:"Party : '"+e.params.Id+"' deleted successfully !",error:"No"}),o.close(),s.end()})}})})}),E.get("/changeprtcode",function(e,s,n){s.render("changeprtcode")}),E.post("/changePartyCode",function(e,s){var n=e.body[0].AC_CODE,o=e.body[0].NEW_AC_CODE,E=new t.Database(a.database,t.OPEN_READWRITE,function(e){if(e)s.status(202).json({message:e.message,error:"Yes"});else{E.get("SELECT 1 FROM ACC_MAST WHERE AC_CODE = ?",[o],function(e,t){if(t)E.close(),s.status(202).json({message:"Cannot change! New Party code already exist !",error:"Yes"}),s.end();else{E.run("UPDATE ACC_MAST SET AC_CODE = ? WHERE AC_CODE = ?",[o,n],function(e,t){if(e)s.status(202).json({message:e.message,error:"Yes"});else{E.run("UPDATE VOUCHERS SET AC_CODE = ? WHERE AC_CODE = ?",[o,n],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):(s.status(202).json({message:"Party code updated successfully!",error:"No"}),E.close(),s.end())})}})}})}})}),e.exports=E},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);E.get("/",function(e,s,n){s.render("trcdmast")}),E.get("/listall",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT CO_CODE, TRCD, DESC FROM TRCD ",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),E.get("/details/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT * FROM TRCD WHERE TRCD = ? ",[e.params.Id],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),E.post("/register",function(e,s){var n=e.body.TRCD,o=e.body.DESC,E=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):E.get("SELECT * FROM TRCD WHERE TRCD = ? ",[n],function(e,t){if(t)s.status(202).json({message:"Cannot add ! Transaction Code already exists!",error:"Yes"});else{E.run("INSERT INTO TRCD (CO_CODE, TRCD, DESC) VALUES ( ?, ?, ? )",[0,n,o],function(e,n){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Transaction Code Added successfully!",error:"Yes"}),s.end(),E.close()})}})})}),E.post("/update",function(e,s){var n=e.body.TRCD,o=e.body.DESC,E=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(s.status(500).json({message:e.message,error:"Yes"}),s.end()):E.get("SELECT 1 FROM TRCD WHERE TRCD = ?",[n],function(e,t){if(t){E.run("UPDATE TRCD SET DESC = ?  WHERE TRCD = ?",[o,n],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Transaction Code updated successfully!",error:"No"}),E.close(),s.end()})}else s.status(202).json({message:'Cannot update ! Group ID "'+n+'" does not exists!',error:"Yes"})})})}),E.post("/delete/:Id",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.status(202).json({message:n.message,error:"Yes"});o.get("SELECT 1 FROM TRANSACT WHERE TRCD = ?",[e.params.Id],function(n,E){if(E)o.close(),s.status(202).json({message:"Cannot delete !! Transaction Code : '"+e.params.Id+"' already in use !",error:"Yes"});else{o.run("DELETE FROM TRCD WHERE TRCD = ?",[e.params.Id],function(n,E){n?s.status(202).json({message:n.message,error:"Yes"}):s.status(202).json({message:"Transaction Code : '"+e.params.Id+"' deleted successfully !",error:"No"}),o.close(),s.end()})}})})}),e.exports=E},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);E.get("/",function(e,s,n){s.render("trcdsubmast")}),E.get("/listall",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT A.*, B.DESC AS TRCDDESC FROM TRCDSUB A, TRCD B WHERE A.TRCD = B.TRCD ",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),E.get("/trcdlist",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT TRCD, DESC AS TRCDDESC FROM TRCD  ",[],function(e,n){e?s.json(e.message):s.json(n),o.close()})})}),E.get("/currentTrcdID/:Nm",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT TRCD FROM TRCD WHERE DESC = ?",[e.params.Nm],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({TRCD:"Incorrect Name"})})});o.close()}),E.get("/details/:Id",function(e,s,n){var o=e.params.Id,E=o.split("-"),r=E[0],C=E[1],A=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),A.all("SELECT A.*, B.DESC AS TRCDDESC FROM TRCDSUB A, TRCD B WHERE A.TRCD = B.TRCD AND A.TRCD = ? AND A.SUBCD = ? ",[r,C],function(e,n){e?s.json(e.message):s.json(n[0])})});A.close()}),E.post("/register",function(e,s){var n=e.body.TRCD,o=e.body.SUBCD,E=e.body.DESC,r=e.body.DEFAULT_AMT,C=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?s.status(202).json({message:e.message,error:"Yes"}):C.get("SELECT * FROM TRCDSUB WHERE TRCD = ? AND SUBCD = ? ",[n,o],function(e,t){if(t)s.status(202).json({message:'Cannot add ! Sub-transaction Code "'+n+"-"+o+'" already exists!',error:"Yes"});else{C.run("INSERT INTO TRCDSUB (CO_CODE, TRCD, SUBCD, DESC, DEFAULT_AMT) VALUES ( ?, ?, ?, ?, ?)",[0,n,o,E,r],function(e,n){e?s.status(202).json({message:"Database Error!",error:"Yes"}):s.status(202).json({message:"Sub-transaction Code Added successfully!",error:"Yes"}),C.close(),s.end()})}})})}),E.post("/update",function(e,s){var n=e.body.TRCD,o=e.body.SUBCD,E=e.body.DESC,r=e.body.DEFAULT_AMT,C=new t.Database(a.database,t.OPEN_READWRITE,function(e){e?(C.close(),s.status(500).json({message:e.message,error:"Yes"}),s.end()):C.get("SELECT 1 FROM TRCDSUB WHERE TRCD = ? AND SUBCD = ?",[n,o],function(e,t){if(t){C.run("UPDATE TRCDSUB SET DESC = ?, DEFAULT_AMT = ? WHERE TRCD = ? AND SUBCD = ?",[E,r,n,o],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Sub-Transaction updated successfully!",error:"No"}),C.close(),s.end()})}else s.status(202).json({message:'Cannot update ! Sub-transaction ID "'+n+"-"+o+'" does not exists!',error:"Yes"})})})}),E.post("/delete/:Id",function(e,s,n){var o=e.params.Id,E=o.split("-"),r=E[0],C=E[1],A=new t.Database(a.database,t.OPEN_READWRITE,function(n){n&&s.status(202).json({message:n.message,error:"Yes"});A.get("SELECT 1 FROM TRANSACT WHERE TRCD = ? AND SUBCD = ?",[r,C],function(n,o){if(o)A.close(),s.status(202).json({message:"Cannot delete !! Transaction Code : '"+e.params.Id+"' already in use !",error:"Yes"});else{A.run("DELETE FROM TRCDSUB WHERE TRCD = ? AND SUBCD = ?",[r,C],function(n,o){n?s.status(202).json({message:n.message,error:"Yes"}):s.status(202).json({message:"Sub-transaction Code : '"+e.params.Id+"' deleted successfully !",error:"No"}),A.close(),s.end()})}})})}),e.exports=E},function(e,s,n){"use strict";function o(e,s){for(var n=e+"";n.length<s;)n="0"+n;return n}function E(e){var s=e.getMonth(),n=e.getFullYear();if(s<=3)var o=n-1,E=n;else var o=n,E=n+1;return o.toString()+"-"+E.toString().substring(2)}function t(e){var s=e.getMonth(),n=e.getFullYear(),E=e.getDate();return n+"-"+o(s+1,2)+"-"+o(E,2)}function a(e,s){var n=new A.Database(D.database,A.OPEN_READWRITE,function(o){if(o)return s(null,!1);n.get("SELECT AC_CODE FROM ACC_MAST WHERE AC_CODE = ?",[e.AC_CODE],function(o,E){if(!E)return n.close(),s(null,!1);var t=!0;n.serialize(function(){for(var o=e.Transactions,E="SELECT COUNT(*) AS CNT FROM (",a=0;a<o.length;a++){var r=o[a].TRCD,C=o[a].SUBCD;E=0==a?E+" SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+r+"' AND SUBCD = '"+C+"' ":E+" UNION ALL SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+r+"' AND SUBCD = '"+C+"'"}E+=")",n.get(E,[],function(e,E){return t=!!E&&o.length==E.CNT,n.close(),s(null,t)})})})})}var r=n(0),C=r.Router(),A=n(2).verbose(),D=n(1),T=(n(30),n(31),n(32).EOL),O=n(5),R=n(6);n(33),n(34),n(35);C.get("/",function(e,s,n){s.render("makebills")}),C.get("/CurrentCoData",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT * FROM COMPANY WHERE CO_CODE = ?",[e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),C.get("/listall",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_STR, A.BILL_NO, A.BILL_DT, A.AC_CODE, B.AC_NAME, A.BILL_AMT, A.PREV_BAL, A.TOT_GST, A.TOT_AMT, A.CLIND  FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.YEAR= ? AND A.CO_CODE = ?  ORDER BY 3",[e.user.DEFAULT_YEAR,e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),C.get("/details/:Id",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT A.*, B.AC_NAME, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.ADDRESS4 FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),C.get("/PreviousBal/:PrtId",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n?(s.json({message:"No Data",error:"No"}),o.close()):o.all("SELECT COUNT(*) AS BILLCOUNT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[e.params.PrtId,e.user.DEFAULT_CO],function(n,E){n?(s.status(202).json({message:"No Data",error:"No"}),o.close()):E[0].BILLCOUNT>0?o.all("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT  FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[e.params.PrtId,e.user.DEFAULT_CO],function(e,n){e?s.json({message:"No Data",error:"No"}):s.json(n[0]),o.close()}):(s.status(202).json({message:"No Data",error:"No"}),o.close())})})}),C.get("/billtranctions/:Id",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n&&s.json(n.message);o.all("SELECT A.BILLID, A.CO_CODE, A.YEAR, A.BILL_NO, A.BILL_DT, A.TRCD, B.DESC AS TRCDDESC, A.SUBCD, C.DESC AS SUBDESC, A.REMARKS, A.BILL_AMT  FROM TRANSACT A, TRCD B, TRCDSUB C  WHERE A.TRCD=B.TRCD  AND A.TRCD=C.TRCD AND A.SUBCD=C.SUBCD  AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),C.get("/billfulldata/:Id",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){var E={};n&&s.json(n.message),o.all("SELECT A.*, B.AC_NAME, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.ADDRESS4 FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(n,t){if(n)s.json(n.message);else{E=t[0];o.all("SELECT A.BILLID, A.CO_CODE, A.YEAR, A.BILL_NO, A.BILL_DT, A.TRCD, B.DESC AS TRCDDESC, A.SUBCD, C.DESC AS SUBDESC, A.REMARKS, A.BILL_AMT  FROM TRANSACT A, TRCD B, TRCDSUB C  WHERE A.TRCD=B.TRCD  AND A.TRCD=C.TRCD AND A.SUBCD=C.SUBCD  AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):(E.transactions=n,s.json(E))})}})});o.close()}),C.post("/register",function(e,s){var n=e.user.DEFAULT_CO,o=0,a=t(new Date(e.body.selectedbillDt)),r=E(new Date(e.body.selectedbillDt)),C=e.body.AC_CODE,T=e.body.TOT_AMT,O=T,R=e.body.isClosed?"Y":"N",u=e.body.LASTBILLID,i=e.body.transactions,l=!1,L="",_=new A.Database(D.database,A.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):_.serialize(function(){_.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,E){o=E.NEWBILLID,_.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR =  ?",[n,r],function(e,E){var t=E&&E.NEWBILL_NO?E.NEWBILL_NO:1;_.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, CLIND, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )",[o,n,t,a,C,O,T,r,R,u],function(e,E){l=!!e,L=e?e.message:"",_.serialize(function(){for(var E=0;E<i.length;E++){var r=i[E].TRCD,C=i[E].SUBCD,A=i[E].REMARKS,D=i[E].BILL_AMT;_.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[o,n,t,a,r,C,A,D],function(e,s){l=!!e,L=e?e.message:""})}l?s.status(202).json({message:e.message,error:"Yes"}):(_.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[u],function(e,s){l=!!e,L=e?e.message:""}),s.status(202).json({message:"Bill Added successfully!",error:"No"})),_.close(),s.end()})})})})})})}),C.post("/update",function(e,s){var n=e.user.DEFAULT_CO,o=e.body.BILLID,E=e.body.BILL_NO,t=e.body.BILL_DT,a=e.body.AC_CODE,r=e.body.TOT_AMT,C=r,T=e.body.isClosed?"Y":"N",O=e.body.transactions,R=!1,u="",i=new A.Database(D.database,A.OPEN_READWRITE,function(e){e?(R=!0,u=e.message):i.get("SELECT 1 FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ?",[n,o],function(e,s){if(s){i.run("UPDATE VOUCHERS SET BILL_DT = ?, AC_CODE = ?, BILL_AMT = ? , TOT_AMT = ?, CLIND = ? WHERE CO_CODE = ? AND BILLID = ?",[t,a,C,r,T,n,o],function(e,s){if(e)R=!0,u=e.message;else{i.run("DELETE FROM TRANSACT  WHERE CO_CODE = ? AND BILLID = ?",[n,o],function(e,s){e?(R=!0,u=e.message):(i.serialize(function(){for(var e=0;e<O.length;e++){var s=O[e].TRCD,a=O[e].SUBCD,r=O[e].REMARKS,C=O[e].BILL_AMT;i.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[o,n,E,t,s,a,r,C],function(e,s){e?(R=!0,u=e.message):R=!1})}}),i.close())})}})}else R=!0,u=json({message:'Cannot update ! Bill "'+E+'" does not exists!',error:"Yes"})})});R?s.status(202).json({message:err.message,error:"Yes"}):s.status(202).json({message:"Bill update successfully!",error:"No"}),s.end()}),C.post("/delete/:Id",function(e,s,n){var o=e.params.Id,E=0,t="",a="",r=new A.Database(D.database,A.OPEN_READWRITE,function(e){if(e)s.status(202).json({message:e.message,error:"Yes"});else{var n="DELETE FROM VOUCHERS WHERE BILLID = ?",C="DELETE FROM TRANSACT WHERE BILLID = ?";r.get("SELECT CO_CODE, AC_CODE, LASTBILLID FROM VOUCHERS WHERE BILLID = ?",[o],function(e,A){E=A.CO_CODE,t=A.AC_CODE,a=A.LASTBILLID,console.log(A.LASTBILLID),0!=a?r.run("UPDATE VOUCHERS SET CLIND = 'N' WHERE CO_CODE= ? AND BILLID= ? AND CLIND = 'Y' ",[E,a],function(e,E){e||r.run(n,[o],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):r.run(C,[o],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Bill deleted successfully !",error:"No"}),r.close(),s.end()})})}):r.run(n,[o],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):r.run(C,[o],function(e,n){e?s.status(202).json({message:e.message,error:"Yes"}):s.status(202).json({message:"Bill deleted successfully !",error:"No"}),r.close(),s.end()})})})}})}),C.get("/trcdlist",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(e){e&&(s.json(e.message),o.close()),o.all("SELECT DESC AS TRCDDESC FROM TRCD ",[],function(e,n){e?s.json(e.message):s.json(n),o.close()})})}),C.get("/currentTrcdID/:Nm",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT TRCD FROM TRCD WHERE DESC = ?",[e.params.Nm],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({TRCD:"Incorrect Name"})})});o.close()}),C.get("/trcdsublist",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT A.TRCD, A.DESC AS TRCDSUBDESC FROM TRCDSUB A ",[],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),C.post("/currentSUBCDIDp",function(e,s,n){var o=e.body.subcdnm,E=e.body.trcdid,t=new A.Database(D.database,A.OPEN_READWRITE,function(e){e&&s.json(e.message),t.all("SELECT SUBCD FROM TRCDSUB WHERE DESC = ? AND TRCD = ?",[o,E],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({SUBCD:"Incorrect Name"})})});t.close()}),C.get("/partylist",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(e){e&&s.json(e.message),o.all("SELECT AC_NAME FROM ACC_MAST",[],function(e,n){e?s.json(e.message):s.json(n),o.close()})})}),C.get("/currentPartyID/:Nm",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT AC_CODE FROM ACC_MAST WHERE AC_NAME = ?",[e.params.Nm],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({AC_CODE:"Invalid Value"}),o.close()})})}),C.get("/currentPartyNm/:Id",function(e,s,n){var o=new A.Database(D.database,A.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT AC_NAME FROM ACC_MAST WHERE AC_CODE = ?",[e.params.Id],function(e,n){e?s.json(e.message):n?s.json(n[0]):s.json({AC_NAME:"Invalid Value"}),o.close()})})});var u=function(e,s,n,o){var E=new A.Database(D.database,A.OPEN_READWRITE,function(t){if(t)return o(null,0);E.get("SELECT BILLID FROM VOUCHERS WHERE CO_CODE = ? AND BILL_NO = ? AND BILL_DT = ?",[e,s,n],function(e,s){return s?o(null,s.BILLID):o(null,0)})})};C.post("/billimport",function(e,s,n){var o=e.body;"Add"==o.ACT?a(o,function(e,n){if(n)var t=new A.Database(D.database,A.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):t.serialize(function(){t.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,n){var a=n.NEWBILLID,r=E(new Date(o.BILL_DATE));t.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR = ?",[o.CO_CODE,r],function(e,n){for(var E=n&&n.NEWBILL_NO?n.NEWBILL_NO:1,C=o.Transactions,A=0,D=0;D<C.length;D++)A+=C[D].Amount;var T=A,O=0,R="";t.get("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[o.AC_CODE,o.CO_CODE],function(e,n){if(n){if(n.BAL_AMT>0){O=n.BAL_AMT,R=n.BILLID;var D={};D.TRCD="OST",D.SUBCD="",D.REMARKS="Bill No : "+n.BILL_NO+" dtd :  "+n.BILL_DT,D.Amount=n.BAL_AMT,C.splice(0,0,D),A+=O,T=A}}else O=0;t.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ? )",[a,o.CO_CODE,E,o.BILL_DATE,o.AC_CODE,T,A,r,R],function(e,n){t.serialize(function(){isError=!1;for(var n=0;n<C.length;n++){var r=C[n].TRCD,A=C[n].SUBCD,D=C[n].REMARKS,T=C[n].Amount;t.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[a,o.CO_CODE,E,o.BILL_DATE,r,A,D,T],function(e,s){isError=!!e})}isError?s.json({ResponseValue:e.message}):(t.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[R],function(e,s){isError=!!e,errMsg=e?e.message:""}),s.json({ResponseValue:"Bill Created!"}))})})})})})})});else s.json({ResponseValue:"Errors in Data!"})}):u(o.CO_CODE,o.BILL_NO,o.BILL_DATE,function(e,n){var E=n;E>0?"Delete"==o.ACT?s.json({ResponseValue:"Bill deleted!"}):a(o,function(e,n){if(n){console.log("updating the bill");var t=new A.Database(D.database,A.OPEN_READWRITE,function(e){t.get("SELECT 'X' FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ? AND CLIND = 'Y' ",[o.CO_CODE,E],function(e,n){if(n)s.json({ResponseValue:"Closed Bill cannot be updated!"});else{for(var a=0,r=o.Transactions,C=0;C<r.length;C++)a+=r[C].Amount;var A=a;t.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE = ? AND BILLID = ?",[A,a,o.CO_CODE,E],function(e,s){if(e)isError=!0,errMsg=e.message;else{t.run("DELETE FROM TRANSACT WHERE CO_CODE = ? AND BILLID = ? AND TRCD <> 'OST' ",[o.CO_CODE,E],function(e,s){e?(isError=!0,errMsg=e.message):t.serialize(function(){for(var e=0;e<r.length;e++){var s=r[e].TRCD,n=r[e].SUBCD,a=r[e].Amount;t.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ? )",[E,o.CO_CODE,o.BILL_NO,o.BILL_DATE,s,n,a],function(e,n){console.log(s),e?(isError=!0,errMsg=e.message,console.log(errMsg)):isError=!1})}t.get("SELECT SUM(BILL_AMT) AS TOTAL FROM TRANSACT WHERE CO_CODE= ? AND BILLID = ?",[o.CO_CODE,E],function(e,s){billtotAmt=s.TOTAL,billtotAmt1=s.TOTAL,t.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE= ? AND BILLID = ?",[billtotAmt,billtotAmt1,o.CO_CODE,E],function(e,s){isError=!!e,errMsg=e?e.message:"",console.log("database Closed"),t.close()})})})})}})}})});s.json({ResponseValue:"Bill updated!"})}else s.json({ResponseValue:"Errors in Data!"})}):s.json({ResponseValue:"Bill not found!"})})}),C.post("/billexport",function(e,s,n){var o=e.body.CO_CODE,E=e.body.YEAR,t=new A.Database(D.database,A.OPEN_READWRITE,function(e){s.statusCode=200,s.setHeader("Content-Type","text/csv");var n="CO_CODE|BILLID|BILL_NO|BILL_DT|AC_NAME|AC_CODE|TRCD_CODE|AMT"+T;t.all("SELECT A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_NO , A.BILL_DT, A.AC_CODE, B.AC_NAME , (C.TRCD || '_' || C.SUBCD) AS TRCD_CODE , C.BILL_AMT FROM VOUCHERS A, ACC_MAST B, TRANSACT C WHERE A.AC_CODE=B.AC_CODE AND C.CO_CODE=A.CO_CODE AND C.BILLID=A.BILLID AND A.CO_CODE= ? AND A.YEAR= ? ORDER BY 2,1",[o,E],function(e,o){if(e)t.close(),s.write("no data found"),s.end();else if(0==o.length)t.close(),s.write("no data found"),s.end();else{s.write(n);var E="";k=0,o.forEach(function(e){k++,E=e.CO_CODE+"|"+e.BILLID+"|"+e.BILL_NO+"|"+e.BILL_DT+"|"+e.AC_NAME+"|"+e.AC_CODE+"|"+e.TRCD_CODE+"|"+e.BILL_AMT+T,s.write(E),k==o.length&&s.end()})}})})}),C.post("/billsemail",function(e,s,n){console.log("sending emails");var o=O.createTransport({service:"gmail",auth:{xoauth2:R.creatXOAuth2Generator({user:"nitin.tandel16@gmail.com",clientId:"857597703416-5gs7tb40dduvr4pa8j97anmqqjml1p79.apps.googleusercontent.com",clientSecret:"xT-ed_l4-wX_6uiYJdNNpUcM",refreshToken:""})}}),E={from:"nitin.tandel16@gmail.com",to:"nitin_tandel16@yahoo.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"};o.sendMail(E,function(e,n){e?(console.log(e),s.json(e)):(console.log("Email sent: "+n.response),s.json({ResponseValue:"sent emails!"}))})}),e.exports=C},function(e,s,n){"use strict";e.exports={pageSize:"A4",pageMargins:[30,10,5,5],content:[{style:"tableExample",table:{widths:[540],body:[[{style:"dtable",table:{widths:[250,10,250],headerRows:1,body:[[{text:"<<CO_NAME>>",style:"tableHeader",colSpan:3,alignment:"center",border:[!1,!1,!1,!1]},{},{}],[{text:"<<CO_ADD>>",colSpan:3,alignment:"center",border:[!1,!1,!1,!1]},{},{}],[{text:"Tel : <<CO_TEL>>",border:[!1,!1,!1,!0]},{text:"",border:[!1,!1,!1,!0]},{text:"<<CO_EMAIL>>",alignment:"right",border:[!1,!1,!1,!0]}]]}}],[{style:"dtable",table:{widths:[250,10,250],headerRows:1,body:[["Bill No : <<BILL_NO>>","",{text:"Bill Date : <<BILL_DATE>>",alignment:"right"}]]},layout:"noBorders"}],[{style:"dtable",table:{widths:[250,10,250],headerRows:1,body:[[{text:"Client Name & Address :",style:"tableHeader",colSpan:3},{},{}],[{text:"<<PARTY_NM>>",colSpan:3},{},{}],[{text:"<<PARTY_ADD1>>",colSpan:3},{},{}],[{text:"<<PARTY_ADD2>>",colSpan:3},{},{}],[{text:"<<PARTY_ADD3>>",colSpan:3},{},{}]]},layout:"noBorders"}],[{style:"dtable",table:{widths:[20,410,80],headerRows:1,body:[[{text:"No",style:"tableHeader"},{text:"Particulars",style:"tableHeader"},{text:"Amount",style:"tableHeader",alignment:"right"}],[{text:"1",alignment:"right"},"<<BILL_TRAN>>",{text:"<<TRAN_AMT>>",alignment:"right"}],["",""," "],[{text:"Total :",style:"tableHeader",colSpan:2},{},{}]]}}],[{style:"dtable",table:{widths:[50,10,450],body:[[{text:"E.& O. E. Bank"},{},{text:"For <<CO_NAME>>,",style:"tableHeader",alignment:"right"}],[{text:"Bank   : "},{},{}],[{text:"A/c No : "},{},{}],[{text:"IFSC   : "},{},{}],[{},{},{text:"Prop.",style:"tableHeader",alignment:"right",border:[!1,!1,!1,!0]}]]},layout:"noBorders"}],[{style:"dtable",table:{widths:[520],body:[[{text:"Developed by A. V. Solutions",border:[!1,!0,!1,!1],pageBreak:"after"}]]}}]]},layout:"noBorders"}],styles:{header:{fontSize:18,bold:!0,margin:[0,0,0,10]},subheader:{fontSize:16,bold:!0,margin:[0,10,0,5]},tableExample:{margin:[0,5,0,15]},tableHeader:{bold:!0,fontSize:13,color:"black"}},defaultStyle:{}}},function(e,s){e.exports=require("async")},function(e,s){e.exports=require("os")},function(e,s){e.exports=require("fs")},function(e,s){e.exports=require("html-pdf")},function(e,s){e.exports=require("http")},function(e,s,n){"use strict";function o(e,s){for(var n=e+"";n.length<s;)n="0"+n;return n}function E(e){var s=e.getMonth(),n=e.getFullYear(),E=e.getDate();return console.log("formatdate"),n+"-"+o(s+1,2)+"-"+o(E,2)}var t=n(0),a=t.Router(),r=n(2).verbose(),C=n(1);a.get("/",function(e,s,n){s.render("enterreceipts")}),a.get("/listall",function(e,s,n){var o=new r.Database(C.database,r.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT A.BILLID, A.CO_CODE, A.BILL_NO, A.BILL_DT, A.AC_CODE, B.AC_NAME, B.GRP_CODE, A.TOT_AMT, A.RCPT_AMT, (A.TOT_AMT -  A.RCPT_AMT) AS BAL_AMT, A.CLIND \n            , SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_STR \n            FROM VOUCHERS A, ACC_MAST B  \n            WHERE A.AC_CODE=B.AC_CODE \n            AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n            AND A.CO_CODE = ? \n            ORDER BY B.GRP_CODE, A.AC_CODE ",[e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),a.get("/details/:Id",function(e,s,n){var o=new r.Database(C.database,r.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT A.*, B.AC_NAME, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.ADDRESS4, (A.TOT_AMT - A.RCPT_AMT) AS BAL_AMT FROM VOUCHERS A, ACC_MAST B WHERE A.AC_CODE=B.AC_CODE AND A.BILLID = ? AND A.CO_CODE = ? ",[e.params.Id,e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n[0])})});o.close()}),a.post("/update",function(e,s){var n=(e.user.DEFAULT_CO,e.body.BILLID),o=e.body.isClosed?"Y":"N",t=e.body.RcptDt1?E(new Date(e.body.RcptDt1)):"",a=e.body.CASH1,A=e.body.CHEQUE1,D=e.body.RcptDt2?E(new Date(e.body.RcptDt2)):"",T=e.body.CASH2,O=e.body.CHEQUE2,R=e.body.CASH,u=e.body.CHEQUE,i=e.body.RCPT_AMT,l=!1,L="",_=new r.Database(C.database,r.OPEN_READWRITE,function(e){if(e)l=!0,L=e.message,s.end();else{_.run("UPDATE VOUCHERS SET RCPT_DATE = ?, CASH1 = ?, CHEQUE1 = ?, RCPT_DATE2 = ?, CASH2 = ?, CHEQUE2 = ?,  CASH = ? , CHEQUE = ? , RCPT_AMT = ?, CLIND = ? WHERE BILLID = ? ",[t,a,A,D,T,O,R,u,i,o,n],function(e,n){console.log(e),e?s.status(202).json({message:e.error,error:"Yes"}):s.status(202).json({message:"Receipts updated successfully!",error:"No"}),_.close(),s.end()})}})}),e.exports=a},function(e,s,n){"use strict";function o(e,s){var n=new C.Database(A.database,C.OPEN_READWRITE,function(o){if(o)return s(null,!1);n.get("SELECT AC_CODE FROM ACC_MAST WHERE AC_CODE = ?",[e.AC_CODE],function(o,E){if(!E)return n.close(),s(null,!1);var t=!0;n.serialize(function(){for(var o=e.Transactions,E="SELECT COUNT(*) AS CNT FROM (",a=0;a<o.length;a++){var r=o[a].TRCD,C=o[a].SUBCD;E=0==a?E+" SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+r+"' AND SUBCD = '"+C+"' ":E+" UNION ALL SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+r+"' AND SUBCD = '"+C+"'"}E+=")",n.get(E,[],function(e,E){return t=!!E&&o.length==E.CNT,n.close(),s(null,t)})})})})}function E(e,s){var n="CREATE TABLE \"COL_REG\" ( 'CO_CODE' INTEGER, 'BILLID' NUMERIC UNIQUE ",o=new C.Database(A.database,C.OPEN_READWRITE,function(e){o.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,E){var t=0;E.forEach(function(e){t++,n=n+", '"+e.COL_HEAD+"' NUMERIC ",t==E.length&&(n+=" , PRIMARY KEY('BILLID') )",o.run("DROP TABLE COL_REG",[],function(e,E){if(e)return o.close(),s(null,!1);o.run(n,[],function(e,n){return o.close(),e?s(null,!1):s(null,!0)})}))})})})}function t(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(E){o.run("INSERT INTO COL_REG (CO_CODE, BILLID) SELECT CO_CODE, BILLID FROM VOUCHERS WHERE CO_CODE=? AND YEAR = ?",[e,s],function(E,t){if(E)return n(null,!1);o.all("SELECT A.CO_CODE, A.BILLID, (A.TRCD || '_' || CASE WHEN A.SUBCD='' THEN 'XXX' ELSE A.SUBCD END) AS COL_HEAD, A.BILL_AMT FROM TRANSACT A, VOUCHERS B WHERE A.CO_CODE=B.CO_CODE AND A.BILLID = B.BILLID AND A.CO_CODE= ? AND B.YEAR = ?",[e,s],function(s,E){o.serialize(function(){var s=0;E.forEach(function(t){var a=t.BILLID,r=t.COL_HEAD,C="UPDATE COL_REG SET "+r+" = "+t.BILL_AMT+" WHERE CO_CODE = ? AND BILLID = ?";o.run(C,[e,a],function(e,t){return e?(o.close(),n(null,!1)):++s==E.length?(o.close(),n(null,!0)):void 0})})})})})})}var a=n(0),r=a.Router(),C=n(2).verbose(),A=n(1),D=n(5),T=n(6);r.get("/",function(e,s,n){s.render("outstandings")}),r.get("/listall",function(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT C.GRP_CODE, A.AC_CODE, C.AC_NAME, B.COMPANY, A.BILL_NO, A.BILL_DT, A.TOT_AMT\n              , (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END) AS RCPT_AMT \n              , (A.TOT_AMT- (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END)) AS BAL_AMT \n              FROM VOUCHERS A, COMPANY B, ACC_MAST C\n              WHERE A.CO_CODE = B.CO_CODE\n              AND A.AC_CODE=C.AC_CODE\n              AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n              AND B.CO_CODE = ?\n              ORDER BY 1, 2",[e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),r.post("/allOS",function(e,s,n){var o=e.body.grouplist,E="SELECT C.GRP_CODE, A.AC_CODE, C.AC_NAME, B.COMPANY, A.BILL_NO, A.BILL_DT, A.TOT_AMT\n              , (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END) AS RCPT_AMT \n              , (A.TOT_AMT- (CASE WHEN A.RCPT_AMT IS NULL THEN 0 ELSE A.RCPT_AMT END)) AS BAL_AMT \n              FROM VOUCHERS A, COMPANY B, ACC_MAST C\n              WHERE A.CO_CODE = B.CO_CODE\n              AND A.AC_CODE=C.AC_CODE\n              AND (A.CLIND <> 'Y' OR A.CLIND IS NULL)\n              <<SPECIFICGROUPOPTION>>\n              ORDER BY 1, 2";E=2==e.body.datascope?E.replace("<<SPECIFICGROUPOPTION>>","AND GRP_CODE IN "+o):E.replace("<<SPECIFICGROUPOPTION>>"," ");var t=new C.Database(A.database,C.OPEN_READWRITE,function(e){e&&s.json(e.message),t.all(E,[],function(e,n){e?s.json(e.message):s.json(n)})});t.close()});var O=function(e,s,n,o){var E=new C.Database(A.database,C.OPEN_READWRITE,function(t){if(t)return o(null,0);E.get("SELECT BILLID FROM VOUCHERS WHERE CO_CODE = ? AND BILL_NO = ? AND BILL_DT = ?",[e,s,n],function(e,s){return s?o(null,s.BILLID):o(null,0)})})};r.post("/billimport",function(e,s,n){var E=e.body;"Add"==E.ACT?o(E,function(e,n){if(n)var o=new C.Database(A.database,C.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):o.serialize(function(){o.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,n){var t=n.NEWBILLID,a=getFinYear(new Date(E.BILL_DATE));o.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR = ?",[E.CO_CODE,a],function(e,n){for(var r=n&&n.NEWBILL_NO?n.NEWBILL_NO:1,C=E.Transactions,A=0,D=0;D<C.length;D++)A+=C[D].Amount;var T=A,O=0,R="";o.get("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[E.AC_CODE,E.CO_CODE],function(e,n){if(n){if(n.BAL_AMT>0){O=n.BAL_AMT,R=n.BILLID;var D={};D.TRCD="OST",D.SUBCD="",D.REMARKS="Bill No : "+n.BILL_NO+" dtd :  "+n.BILL_DT,D.Amount=n.BAL_AMT,C.splice(0,0,D),A+=O,T=A}}else O=0;o.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ? )",[t,E.CO_CODE,r,E.BILL_DATE,E.AC_CODE,T,A,a,R],function(e,n){o.serialize(function(){isError=!1;for(var n=0;n<C.length;n++){var a=C[n].TRCD,A=C[n].SUBCD,D=C[n].REMARKS,T=C[n].Amount;o.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[t,E.CO_CODE,r,E.BILL_DATE,a,A,D,T],function(e,s){isError=!!e})}isError?s.json({ResponseValue:e.message}):(o.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[R],function(e,s){isError=!!e,errMsg=e?e.message:""}),s.json({ResponseValue:"Bill Created!"}))})})})})})})});else s.json({ResponseValue:"Errors in Data!"})}):O(E.CO_CODE,E.BILL_NO,E.BILL_DATE,function(e,n){var t=n;t>0?"Delete"==E.ACT?s.json({ResponseValue:"Bill deleted!"}):o(E,function(e,n){if(n){console.log("updating the bill");var o=new C.Database(A.database,C.OPEN_READWRITE,function(e){o.get("SELECT 'X' FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ? AND CLIND = 'Y' ",[E.CO_CODE,t],function(e,n){if(n)s.json({ResponseValue:"Closed Bill cannot be updated!"});else{for(var a=0,r=E.Transactions,C=0;C<r.length;C++)a+=r[C].Amount;var A=a;o.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE = ? AND BILLID = ?",[A,a,E.CO_CODE,t],function(e,s){if(e)isError=!0,errMsg=e.message;else{o.run("DELETE FROM TRANSACT WHERE CO_CODE = ? AND BILLID = ? AND TRCD <> 'OST' ",[E.CO_CODE,t],function(e,s){e?(isError=!0,errMsg=e.message):o.serialize(function(){for(var e=0;e<r.length;e++){var s=r[e].TRCD,n=r[e].SUBCD,a=r[e].Amount;o.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ? )",[t,E.CO_CODE,E.BILL_NO,E.BILL_DATE,s,n,a],function(e,n){console.log(s),e?(isError=!0,errMsg=e.message,console.log(errMsg)):isError=!1})}o.get("SELECT SUM(BILL_AMT) AS TOTAL FROM TRANSACT WHERE CO_CODE= ? AND BILLID = ?",[E.CO_CODE,t],function(e,s){billtotAmt=s.TOTAL,billtotAmt1=s.TOTAL,o.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE= ? AND BILLID = ?",[billtotAmt,billtotAmt1,E.CO_CODE,t],function(e,s){isError=!!e,errMsg=e?e.message:"",console.log("database Closed"),o.close()})})})})}})}})});s.json({ResponseValue:"Bill updated!"})}else s.json({ResponseValue:"Errors in Data!"})}):s.json({ResponseValue:"Bill not found!"})})}),r.post("/billexport",function(e,s,n){var o=e.body.CO_CODE,a=e.body.YEAR;E(e.body,function(e,n){n?t(o,a,function(e,n){if(n)var o=new C.Database(A.database,C.OPEN_READWRITE,function(e){s.statusCode=200,s.setHeader("Content-Type","text/csv");var n="CO_CODE, BILL_NO, BILL_DT, AC_NAME, AC_CODE ";o.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,E){k=0,E.forEach(function(e){n=n+","+e.COL_HEAD,++k==E.length&&(n+=endOfLine)}),o.all("SELECT A.CO_CODE AS CCODE, B.BILL_NO, B.BILL_DT, C.AC_NAME, B.AC_CODE, A.* FROM COL_REG A, VOUCHERS B, ACC_MAST C WHERE A.CO_CODE=B.CO_CODE AND A.BILLID=B.BILLID AND B.AC_CODE = C.AC_CODE",[],function(e,E){e?(o.close(),s.write("no data found"),s.end()):(s.write(n),i=0,E.forEach(function(e){var n="";for(var t in e)if("CO_CODE"!=t&&"BILLID"!=t){var a=null==e[t]?"0":e[t];n=n+a+","}n+=endOfLine,s.write(n),++i==E.length&&(o.close(),s.end())}))})})});else s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end()}):(s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end())})}),r.post("/osemail",function(e,s,n){console.log("sending emails for outstanding");var o=D.createTransport({service:"gmail",auth:{xoauth2:T.creatXOAuth2Generator({user:"nitin.tandel16@gmail.com",clientId:"857597703416-5gs7tb40dduvr4pa8j97anmqqjml1p79.apps.googleusercontent.com",clientSecret:"xT-ed_l4-wX_6uiYJdNNpUcM",refreshToken:""})}}),E={from:"nitin.tandel16@gmail.com",to:"nitin_tandel16@yahoo.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"};o.sendMail(E,function(e,n){e?(console.log(e),s.json(e)):(console.log("Email sent: "+n.response),s.json({ResponseValue:"sent emails!"}))})}),e.exports=r},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);E.get("/",function(e,s,n){s.render("billreg")}),E.post("/billsdata",function(e,s,n){var o=e.body.CO_CODE,E=e.body.YEAR,r=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),r.all("SELECT A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4) AS BILL_NO , A.BILL_DT\n             , B.GRP_CODE , A.AC_CODE, B.AC_NAME , C.TRCD  , SUM(C.BILL_AMT) AS BILLAMT, A.RCPT_AMT, RCPT_DATE \n             , GROUP_CONCAT(C.TRCD || C.SUBCD) AS TRANLIST  \n             FROM VOUCHERS A, ACC_MAST B, TRANSACT C \n             WHERE A.AC_CODE=B.AC_CODE AND C.CO_CODE=A.CO_CODE AND C.BILLID=A.BILLID \n             AND A.CO_CODE= ? AND A.YEAR= ?\n             GROUP BY A.BILLID, A.CO_CODE, SUBSTR('0000'|| A.BILL_NO, -4, 4), A.BILL_DT, A.AC_CODE, B.AC_NAME , C.TRCD , A.RCPT_AMT, RCPT_DATE\n             ORDER BY 2,1",[o,E],function(e,n){e?s.json(e.message):s.json(n)})});r.close()}),E.post("/headernames",function(e,s,n){var o=e.body.CO_CODE,E=e.body.YEAR,r=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),r.all("SELECT DISTINCT C.TRCD, C.DESC \n             FROM VOUCHERS A,  TRANSACT B , TRCD C\n             WHERE A.CO_CODE=A.CO_CODE AND A.BILLID=B.BILLID AND B.TRCD = C.TRCD\n             AND B.TRCD<>'OST'\n             AND A.CO_CODE= ? AND A.YEAR= ?",[o,E],function(e,n){e?s.json(e.message):s.json(n)})});r.close()}),E.get("/CurrentYearData",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n?s.json(n.message):o.get("SELECT USERID, YEAR, FROM_DT, TO_DT FROM USERS A, YEARS B WHERE A.DEFAULT_YEAR  = B.YEAR AND B.YEAR = ? ",[e.user.DEFAULT_YEAR],function(e,n){n?s.json(n):s.json(e.message)}),o.close()})}),e.exports=E},function(e,s,n){"use strict";var o=n(0),E=o.Router(),t=n(2).verbose(),a=n(1);E.get("/",function(e,s,n){s.render("ledgers")}),E.post("/ledgerdata",function(e,s,n){var o=e.body.CO_CODE,E=(e.body.YEAR,e.body.FROM_DT),r=e.body.TO_DT,C=e.body.datascope,A=e.body.partylist,D=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message);var n="SELECT A.AC_CODE, B.AC_NAME, '<<FROM_DT>>' AS TRAN_DT, 'Opening Balance ... ' AS TRAN, 0 AS BILL_AMOUNT, 0 AS RCPT_AMOUNT,  CASE WHEN  A.CLIND ='Y' THEN 0 ELSE  SUM( TOT_AMT - RCPT_AMT ) END AS BAL_AMT , 'N' AS CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.BILL_DT < '<<FROM_DT>>'\n              AND A.RCPT_DATE < '<<FROM_DT>>'\n              AND A.RCPT_DATE2 < '<<FROM_DT>>'\n              AND A.CO_CODE = <<CO_CODE>>\n              <<SELECTED_PARTIES>>\n              GROUP BY A.AC_CODE, 'Opening Balance ... '\n              UNION \n              SELECT A.AC_CODE, B.AC_NAME, A.BILL_DT AS TRAN_DT, 'Bill No : ' || A.BILL_NO AS TRAN, A.TOT_AMT AS BILL_AMOUNT, 0 AS RCPT_AMOUNT , 0 AS BAL_AMT, A.CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.CO_CODE = <<CO_CODE>>\n              AND A.BILL_DT BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n              <<SELECTED_PARTIES>>\n              UNION\n              SELECT A.AC_CODE, B.AC_NAME, A.RCPT_DATE  AS TRAN_DT, 'Receipt'  AS TRAN, 0 AS BILL_AMOUNT, A.CASH1 + A.CHEQUE1 AS  RCPT_AMOUNT , 0 AS BAL_AMT, A.CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.CO_CODE = <<CO_CODE>>\n              AND A.CASH1 + A.CHEQUE1 > 0\n              AND A.RCPT_DATE BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n              <<SELECTED_PARTIES>>\n              UNION\n              SELECT A.AC_CODE, B.AC_NAME,  A.RCPT_DATE2  AS TRAN_DT, 'Receipt'  AS TRAN, 0 AS BILL_AMOUNT, A.CASH2 + A.CHEQUE2 AS  RCPT_AMOUNT , 0 AS BAL_AMT , A.CLIND\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE = B.AC_CODE \n              AND A.CO_CODE = <<CO_CODE>>\n              AND A.CASH2 + A.CHEQUE2 > 0\n              AND A.RCPT_DATE2 BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n              <<SELECTED_PARTIES>>\n              ORDER BY 1, 3";n=n.replace(/<<FROM_DT>>/g,E),n=n.replace(/<<TO_DT>>/g,r),n=n.replace(/<<CO_CODE>>/g,o),n=2==C?n.replace(/<<SELECTED_PARTIES>>/g,"AND A.AC_CODE IN "+A):n.replace(/<<SELECTED_PARTIES>>/g,""),console.log(n),D.all(n,[],function(e,n){e?(console.log(e),s.json(e.message)):s.json(n)})});D.close()}),E.post("/headernames",function(e,s,n){var o=e.body.CO_CODE,E=e.body.YEAR,r=new t.Database(a.database,t.OPEN_READWRITE,function(e){e&&s.json(e.message),r.all("SELECT DISTINCT C.TRCD, C.DESC \n             FROM VOUCHERS A,  TRANSACT B , TRCD C\n             WHERE A.CO_CODE=A.CO_CODE AND A.BILLID=B.BILLID AND B.TRCD = C.TRCD\n             AND B.TRCD<>'OST'\n             AND A.CO_CODE= ? AND A.YEAR= ?",[o,E],function(e,n){e?s.json(e.message):s.json(n)})});r.close()}),E.get("/CurrentYearData",function(e,s,n){var o=new t.Database(a.database,t.OPEN_READWRITE,function(n){n?s.json(n.message):o.get("SELECT USERID, YEAR, FROM_DT, TO_DT FROM USERS A, YEARS B WHERE A.DEFAULT_YEAR  = B.YEAR AND B.YEAR = ? ",[e.user.DEFAULT_YEAR],function(e,n){n?s.json(n):s.json(e.message)}),o.close()})}),e.exports=E},function(e,s,n){"use strict";function o(e,s){var n=new C.Database(A.database,C.OPEN_READWRITE,function(o){if(o)return s(null,!1);n.get("SELECT AC_CODE FROM ACC_MAST WHERE AC_CODE = ?",[e.AC_CODE],function(o,E){if(!E)return n.close(),s(null,!1);var t=!0;n.serialize(function(){for(var o=e.Transactions,E="SELECT COUNT(*) AS CNT FROM (",a=0;a<o.length;a++){var r=o[a].TRCD,C=o[a].SUBCD;E=0==a?E+" SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+r+"' AND SUBCD = '"+C+"' ":E+" UNION ALL SELECT SUBCD FROM TRCDSUB WHERE TRCD = '"+r+"' AND SUBCD = '"+C+"'"}E+=")",n.get(E,[],function(e,E){return t=!!E&&o.length==E.CNT,n.close(),s(null,t)})})})})}function E(e,s){var n="CREATE TABLE \"COL_REG\" ( 'CO_CODE' INTEGER, 'BILLID' NUMERIC UNIQUE ",o=new C.Database(A.database,C.OPEN_READWRITE,function(e){o.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,E){var t=0;E.forEach(function(e){t++,n=n+", '"+e.COL_HEAD+"' NUMERIC ",t==E.length&&(n+=" , PRIMARY KEY('BILLID') )",o.run("DROP TABLE COL_REG",[],function(e,E){if(e)return o.close(),s(null,!1);o.run(n,[],function(e,n){return o.close(),e?s(null,!1):s(null,!0)})}))})})})}function t(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(E){o.run("INSERT INTO COL_REG (CO_CODE, BILLID) SELECT CO_CODE, BILLID FROM VOUCHERS WHERE CO_CODE=? AND YEAR = ?",[e,s],function(E,t){if(E)return n(null,!1);o.all("SELECT A.CO_CODE, A.BILLID, (A.TRCD || '_' || CASE WHEN A.SUBCD='' THEN 'XXX' ELSE A.SUBCD END) AS COL_HEAD, A.BILL_AMT FROM TRANSACT A, VOUCHERS B WHERE A.CO_CODE=B.CO_CODE AND A.BILLID = B.BILLID AND A.CO_CODE= ? AND B.YEAR = ?",[e,s],function(s,E){o.serialize(function(){var s=0;E.forEach(function(t){var a=t.BILLID,r=t.COL_HEAD,C="UPDATE COL_REG SET "+r+" = "+t.BILL_AMT+" WHERE CO_CODE = ? AND BILLID = ?";o.run(C,[e,a],function(e,t){return e?(o.close(),n(null,!1)):++s==E.length?(o.close(),n(null,!0)):void 0})})})})})})}var a=n(0),r=a.Router(),C=n(2).verbose(),A=n(1),D=n(5),T=n(6);r.get("/",function(e,s,n){s.render("rcptreg")}),r.get("/listall",function(e,s,n){var o=new C.Database(A.database,C.OPEN_READWRITE,function(n){n&&s.json(n.message),o.all("SELECT A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME,  A.BILL_NO, A.TOT_AMT, A.RCPT_DATE, CASH1, CHEQUE1 , (CASH1 + CHEQUE1 ) AS RCPT_AMOUNT\n              FROM VOUCHERS A, ACC_MAST B\n              WHERE A.AC_CODE= B.AC_CODE AND A.RCPT_DATE BETWEEN '2017-04-01' AND '2018-03-31'\n              AND A.CO_CODE = 2\n              AND CASH1 + CHEQUE1 > 0\nUNION \nSELECT A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME,  A.BILL_NO, A.TOT_AMT, A.RCPT_DATE2, CASH2, CHEQUE2 , (CASH2 + CHEQUE2 ) AS RCPT_AMOUNT\nFROM VOUCHERS A, ACC_MAST B\nWHERE A.AC_CODE = B.AC_CODE AND A.RCPT_DATE2 BETWEEN '2017-04-01' AND '2018-03-31'\nAND CASH2 + CHEQUE2 > 0\nAND A.CO_CODE = 2\nORDER BY 1, 7",[e.user.DEFAULT_CO],function(e,n){e?s.json(e.message):s.json(n)})});o.close()}),r.post("/rcptregdata",function(e,s,n){var o=e.body.CO_CODE,E=e.body.FROM_DT,t=e.body.TO_DT,a=(e.body.datascope,e.body.partylist,e.body.grouplist),r="SELECT A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME, A.BILL_NO, A.TOT_AMT, A.RCPT_DATE, CASH1, CHEQUE1 , (CASH1 + CHEQUE1 ) AS RCPT_AMOUNT\n                  FROM VOUCHERS A, ACC_MAST B\n                  WHERE A.AC_CODE= B.AC_CODE AND A.RCPT_DATE BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n                  AND A.CO_CODE = <<CO_CODE>>\n                  AND CASH1 + CHEQUE1 > 0\n                  <<SPECIFICGROUPOPTION>>\n                  <<SPECIFIC_PARTYOPTION>>\n                  UNION \n                  SELECT A.CO_CODE, A.BILLID, A.AC_CODE, B.AC_NAME,  A.BILL_NO, A.TOT_AMT, A.RCPT_DATE2, CASH2, CHEQUE2 , (CASH2 + CHEQUE2 ) AS RCPT_AMOUNT\n                  FROM VOUCHERS A, ACC_MAST B\n                  WHERE A.AC_CODE = B.AC_CODE AND A.RCPT_DATE2 BETWEEN '<<FROM_DT>>' AND '<<TO_DT>>'\n                  AND CASH2 + CHEQUE2 > 0\n                  AND A.CO_CODE = <<CO_CODE>>\n                  <<SPECIFICGROUPOPTION>>\n                  <<SPECIFIC_PARTYOPTION>>\n                  ORDER BY 1, 7";r=r.replace(/<<FROM_DT>>/g,E),r=r.replace(/<<TO_DT>>/g,t),r=r.replace(/<<CO_CODE>>/g,o),r=r.replace(/<<SPECIFIC_PARTYOPTION>>/g,""),r=2==e.body.datascope?r.replace(/<<SPECIFICGROUPOPTION>>/g,"AND B.GRP_CODE IN "+a):r.replace(/<<SPECIFICGROUPOPTION>>/g,"");var D=new C.Database(A.database,C.OPEN_READWRITE,function(e){e&&s.json(e.message),D.all(r,[],function(e,n){e?s.json(e.message):s.json(n)})});D.close()});var O=function(e,s,n,o){var E=new C.Database(A.database,C.OPEN_READWRITE,function(t){if(t)return o(null,0);E.get("SELECT BILLID FROM VOUCHERS WHERE CO_CODE = ? AND BILL_NO = ? AND BILL_DT = ?",[e,s,n],function(e,s){return s?o(null,s.BILLID):o(null,0)})})};r.post("/billimport",function(e,s,n){var E=e.body;"Add"==E.ACT?o(E,function(e,n){if(n)var o=new C.Database(A.database,C.OPEN_READWRITE,function(e){e?s.status(500).json({message:e.message,error:"Yes"}):o.serialize(function(){o.get("SELECT MAX(BILLID)+1 AS NEWBILLID FROM VOUCHERS",[],function(e,n){var t=n.NEWBILLID,a=getFinYear(new Date(E.BILL_DATE));o.get("SELECT MAX(CAST(BILL_NO AS LONG ))+1 AS NEWBILL_NO FROM VOUCHERS WHERE CO_CODE = ? AND YEAR = ?",[E.CO_CODE,a],function(e,n){for(var r=n&&n.NEWBILL_NO?n.NEWBILL_NO:1,C=E.Transactions,A=0,D=0;D<C.length;D++)A+=C[D].Amount;var T=A,O=0,R="";o.get("SELECT BILLID, BILL_NO, BILL_DT, (TOT_AMT - RCPT_AMT) AS BAL_AMT FROM VOUCHERS WHERE AC_CODE= ? AND CLIND <> 'Y' AND CO_CODE= ? ",[E.AC_CODE,E.CO_CODE],function(e,n){if(n){if(n.BAL_AMT>0){O=n.BAL_AMT,R=n.BILLID;var D={};D.TRCD="OST",D.SUBCD="",D.REMARKS="Bill No : "+n.BILL_NO+" dtd :  "+n.BILL_DT,D.Amount=n.BAL_AMT,C.splice(0,0,D),A+=O,T=A}}else O=0;o.run("INSERT INTO VOUCHERS (BILLID, CO_CODE, BILL_NO, BILL_DT, AC_CODE, BILL_AMT, TOT_AMT, YEAR, LASTBILLID) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ? )",[t,E.CO_CODE,r,E.BILL_DATE,E.AC_CODE,T,A,a,R],function(e,n){o.serialize(function(){isError=!1;for(var n=0;n<C.length;n++){var a=C[n].TRCD,A=C[n].SUBCD,D=C[n].REMARKS,T=C[n].Amount;o.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, REMARKS, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ?, ? )",[t,E.CO_CODE,r,E.BILL_DATE,a,A,D,T],function(e,s){isError=!!e})}isError?s.json({ResponseValue:e.message}):(o.run("UPDATE VOUCHERS SET CLIND='Y' WHERE BILLID = ?",[R],function(e,s){isError=!!e,errMsg=e?e.message:""}),s.json({ResponseValue:"Bill Created!"}))})})})})})})});else s.json({ResponseValue:"Errors in Data!"})}):O(E.CO_CODE,E.BILL_NO,E.BILL_DATE,function(e,n){var t=n;t>0?"Delete"==E.ACT?s.json({ResponseValue:"Bill deleted!"}):o(E,function(e,n){if(n){console.log("updating the bill");var o=new C.Database(A.database,C.OPEN_READWRITE,function(e){o.get("SELECT 'X' FROM VOUCHERS WHERE CO_CODE = ? AND BILLID = ? AND CLIND = 'Y' ",[E.CO_CODE,t],function(e,n){if(n)s.json({ResponseValue:"Closed Bill cannot be updated!"});else{for(var a=0,r=E.Transactions,C=0;C<r.length;C++)a+=r[C].Amount;var A=a;o.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE = ? AND BILLID = ?",[A,a,E.CO_CODE,t],function(e,s){if(e)isError=!0,errMsg=e.message;else{o.run("DELETE FROM TRANSACT WHERE CO_CODE = ? AND BILLID = ? AND TRCD <> 'OST' ",[E.CO_CODE,t],function(e,s){e?(isError=!0,errMsg=e.message):o.serialize(function(){for(var e=0;e<r.length;e++){var s=r[e].TRCD,n=r[e].SUBCD,a=r[e].Amount;o.run("INSERT INTO TRANSACT (BILLID, CO_CODE, BILL_NO, BILL_DT, TRCD, SUBCD, BILL_AMT) VALUES ( ?, ?, ?, ?, ?, ?, ? )",[t,E.CO_CODE,E.BILL_NO,E.BILL_DATE,s,n,a],function(e,n){console.log(s),e?(isError=!0,errMsg=e.message,console.log(errMsg)):isError=!1})}o.get("SELECT SUM(BILL_AMT) AS TOTAL FROM TRANSACT WHERE CO_CODE= ? AND BILLID = ?",[E.CO_CODE,t],function(e,s){billtotAmt=s.TOTAL,billtotAmt1=s.TOTAL,o.run("UPDATE VOUCHERS SET BILL_AMT = ? , TOT_AMT = ? WHERE CO_CODE= ? AND BILLID = ?",[billtotAmt,billtotAmt1,E.CO_CODE,t],function(e,s){isError=!!e,errMsg=e?e.message:"",console.log("database Closed"),o.close()})})})})}})}})});s.json({ResponseValue:"Bill updated!"})}else s.json({ResponseValue:"Errors in Data!"})}):s.json({ResponseValue:"Bill not found!"})})}),r.post("/billexport",function(e,s,n){var o=e.body.CO_CODE,a=e.body.YEAR;E(e.body,function(e,n){n?t(o,a,function(e,n){if(n)var o=new C.Database(A.database,C.OPEN_READWRITE,function(e){s.statusCode=200,s.setHeader("Content-Type","text/csv");var n="CO_CODE, BILL_NO, BILL_DT, AC_NAME, AC_CODE ";o.all("SELECT (TRCD || '_' || CASE WHEN SUBCD='' THEN 'XXX' ELSE SUBCD END) AS COL_HEAD FROM TRCDSUB ORDER BY TRCD, SUBCD",[],function(e,E){k=0,E.forEach(function(e){n=n+","+e.COL_HEAD,++k==E.length&&(n+=endOfLine)}),o.all("SELECT A.CO_CODE AS CCODE, B.BILL_NO, B.BILL_DT, C.AC_NAME, B.AC_CODE, A.* FROM COL_REG A, VOUCHERS B, ACC_MAST C WHERE A.CO_CODE=B.CO_CODE AND A.BILLID=B.BILLID AND B.AC_CODE = C.AC_CODE",[],function(e,E){e?(o.close(),s.write("no data found"),s.end()):(s.write(n),i=0,E.forEach(function(e){var n="";for(var t in e)if("CO_CODE"!=t&&"BILLID"!=t){var a=null==e[t]?"0":e[t];n=n+a+","}n+=endOfLine,s.write(n),++i==E.length&&(o.close(),s.end())}))})})});else s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end()}):(s.statusCode=200,s.setHeader("Content-Type","text/csv"),s.write("no data found"),s.end())})}),r.post("/osemail",function(e,s,n){console.log("sending emails for outstanding");var o=D.createTransport({service:"gmail",auth:{xoauth2:T.creatXOAuth2Generator({user:"nitin.tandel16@gmail.com",clientId:"857597703416-5gs7tb40dduvr4pa8j97anmqqjml1p79.apps.googleusercontent.com",clientSecret:"xT-ed_l4-wX_6uiYJdNNpUcM",refreshToken:""})}}),E={from:"nitin.tandel16@gmail.com",to:"nitin_tandel16@yahoo.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"};o.sendMail(E,function(e,n){e?(console.log(e),s.json(e)):(console.log("Email sent: "+n.response),s.json({ResponseValue:"sent emails!"}))})}),e.exports=r}]);